<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BabyUp ¬∑ Êô∫ËÉΩÊàêÈïøÂä©Êâã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* BabyUp ÂìÅÁâåËâ≤Á≥ªÔºöÊõ¥Ê¥ªÊ≥ºÁöÑÊ∏êÂèò */
        body { 
            background: linear-gradient(135deg, #FFF0F5 0%, #E0F7FA 100%); 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }
        .btn-brand {
            background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); /* ÊöñËâ≤Ë∞É */
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            transition: all 0.2s ease;
        }
        .btn-brand:active { transform: scale(0.96); }
        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid #F3F4F6;
            transition: all 0.3s;
        }
        .input-glass:focus {
            background: white;
            border-color: #FF8E53;
            box-shadow: 0 0 0 3px rgba(255, 142, 83, 0.1);
        }
        .lang-switch {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px;
            font-weight: 800; color: #FF6B6B; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            cursor: pointer; transition: transform 0.2s;
        }
        .lang-switch:hover { transform: scale(1.05); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-slate-700 min-h-screen">
    <div id="app" class="max-w-5xl mx-auto min-h-screen relative pb-20"> <button @click="toggleLang" class="lang-switch">
            {{ lang === 'zh' ? 'üá∫üá∏ English' : 'üá®üá≥ ‰∏≠Êñá' }}
        </button>

        <div v-if="globalLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/90 backdrop-blur-md">
            <div class="animate-bounce text-4xl mb-4">üë∂</div>
            <p class="text-slate-500 font-bold tracking-widest">BabyUp Loading...</p>
        </div>

        <transition name="fade">
            <div v-if="!user" class="p-6 pt-20 flex flex-col items-center justify-center min-h-screen max-w-md mx-auto">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400">BabyUp</h1>
                    <p class="text-slate-400 mt-2 font-bold tracking-wide text-sm uppercase">{{ t.slogan }}</p>
                </div>
                
                <div class="glass-card rounded-3xl p-8 w-full">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">{{ t.login_title }}</h2>
                    <div v-if="!sentCode">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">{{ t.email_label }}</label>
                        <input type="email" v-model="email" placeholder="name@example.com" class="input-glass w-full rounded-xl p-4 outline-none mb-6">
                        <button @click="sendMagicCode" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl">
                            {{ loading ? t.sending : t.send_btn }}
                        </button>
                    </div>
                    <div v-else>
                        <p class="text-sm text-slate-500 mb-4">{{ t.code_sent_to }} <strong class="text-orange-500">{{ email }}</strong></p>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">{{ t.code_label }}</label>
                        <input type="text" v-model="otpToken" placeholder="123456" maxlength="6" class="input-glass w-full rounded-xl p-4 outline-none mb-6 text-center text-3xl tracking-[0.5em] font-mono font-bold text-slate-700">
                        <button @click="verifyOtp" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl mb-4">
                            {{ loading ? t.verifying : t.login_confirm }}
                        </button>
                        <button @click="sentCode = false" class="w-full text-sm text-slate-400 hover:text-orange-500">{{ t.back_email }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user" class="p-4 pt-4">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-2">
                         <span class="text-2xl font-extrabold text-orange-500">BabyUp</span>
                         <span v-if="currentBaby" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold">{{ currentBaby.name }}</span>
                    </div>
                    <div class="flex gap-4 text-sm font-bold text-slate-400">
                        <button v-if="currentBaby" @click="currentBaby = null" class="hover:text-slate-600">{{ t.switch_baby }}</button>
                        <button @click="signOut" class="hover:text-red-500">{{ t.logout }}</button>
                    </div>
                </div>

                <div v-if="!currentBaby && !showAddBabyForm" class="max-w-md mx-auto">
                    <div v-if="babies.length === 0" class="text-center py-20">
                        <div class="text-6xl mb-4">üê£</div>
                        <p class="text-slate-500 mb-6 font-bold">{{ t.no_baby }}</p>
                        <button @click="showAddBabyForm = true" class="btn-brand text-white px-8 py-3 rounded-full font-bold shadow-lg">
                            + {{ t.add_baby }}
                        </button>
                    </div>
                    <div v-else class="grid gap-4">
                        <div v-for="baby in babies" :key="baby.id" @click="selectBaby(baby)" class="glass-card p-5 rounded-2xl flex items-center justify-between cursor-pointer hover:scale-[1.02] transition transform">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl" :class="baby.gender === 'male' ? 'bg-blue-100' : 'bg-pink-100'">
                                    {{ baby.gender === 'male' ? 'üë¶' : 'üëß' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">{{ baby.name }}</h3>
                                    <p class="text-xs text-slate-500 font-bold">{{ calculateAge(baby.birth_date) }}</p>
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">‚ûú</div>
                        </div>
                        <button @click="showAddBabyForm = true" class="mt-4 w-full py-4 border-2 border-dashed border-slate-200 text-slate-400 rounded-2xl font-bold hover:border-orange-300 hover:text-orange-500 transition">
                            + {{ t.add_another }}
                        </button>
                    </div>
                </div>

                <div v-if="showAddBabyForm" class="max-w-md mx-auto pt-10">
                    <button @click="showAddBabyForm = false" class="text-slate-400 mb-6 font-bold flex items-center gap-1">‚Üê {{ t.back }}</button>
                    <div class="glass-card rounded-3xl p-6 space-y-4">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">{{ t.new_profile }}</h2>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">{{ t.nickname }}</label>
                            <input type="text" v-model="newBaby.name" class="input-glass w-full rounded-xl p-3 mt-1">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">{{ t.gender }}</label>
                            <div class="flex gap-4 mt-1">
                                <button @click="newBaby.gender = 'male'" :class="newBaby.gender === 'male' ? 'bg-blue-500 text-white ring-2 ring-blue-200' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition">{{ t.boy }}</button>
                                <button @click="newBaby.gender = 'female'" :class="newBaby.gender === 'female' ? 'bg-pink-500 text-white ring-2 ring-pink-200' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition">{{ t.girl }}</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">{{ t.birth_date }}</label>
                            <input type="date" v-model="newBaby.birth_date" class="input-glass w-full rounded-xl p-3 mt-1">
                        </div>
                        <button @click="createBaby" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl mt-4">
                            {{ loading ? t.saving : t.create_btn }}
                        </button>
                    </div>
                </div>

                <div v-if="currentBaby" class="pb-20">
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        
                        <div class="md:col-span-4 space-y-6">
                            
                            <div class="glass-card rounded-3xl p-5 border-l-4 border-orange-400 relative">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                    <span>{{ isEditing ? t.edit_mode : t.record_entry }}</span>
                                    <button v-if="isEditing" @click="cancelEdit" class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded">Cancel</button>
                                </h3>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    <input type="date" v-model="input.date" class="input-glass rounded-xl p-3 text-sm font-bold text-slate-600">
                                    
                                    <div class="relative">
                                        <input type="number" v-model="input.weight" :placeholder="t.weight_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16">
                                        <span class="absolute right-3 top-3 text-xs font-bold text-orange-400">{{ percentiles.weight }}</span>
                                    </div>

                                    <div class="relative">
                                        <input type="number" v-model="input.height" :placeholder="t.height_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16">
                                        <span class="absolute right-3 top-3 text-xs font-bold text-teal-500">{{ percentiles.height }}</span>
                                    </div>

                                    <div class="relative">
                                        <input type="number" v-model="input.head" :placeholder="t.head_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16">
                                        <span class="absolute right-3 top-3 text-xs font-bold text-purple-500">{{ percentiles.head }}</span>
                                    </div>
                                </div>

                                <button @click="submitRecord" :disabled="loading" class="btn-brand w-full text-white font-bold py-3 rounded-xl mt-4 shadow-md flex justify-center items-center gap-2">
                                    <span v-if="loading" class="animate-spin">‚è≥</span>
                                    <span>{{ isEditing ? t.update_btn : t.gen_report }}</span>
                                </button>
                            </div>

                            <div class="bg-white/50 rounded-3xl p-5">
                                <h3 class="font-bold text-slate-700 mb-3 ml-1">{{ t.history_title }}</h3>
                                <div class="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                                    <div v-for="record in records" :key="record.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-bold text-slate-700 text-sm">{{ record.date }}</span>
                                                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">Day {{ record.days }}</span>
                                                </div>
                                                <div class="text-xs text-slate-500 space-x-2">
                                                    <span class="font-bold text-pink-500">{{ record.weight }}kg</span>
                                                    <span class="font-bold text-teal-500">{{ record.height }}cm</span>
                                                    <span v-if="record.head" class="text-purple-400">{{ record.head }}cm</span>
                                                </div>
                                            </div>
                                            
                                            <div class="flex flex-col gap-2">
                                                <button @click="openReport(record)" class="text-[10px] bg-orange-50 text-orange-500 px-3 py-1.5 rounded-lg font-bold hover:bg-orange-100">
                                                    {{ t.view_report }}
                                                </button>
                                                <div class="flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button @click="editRecord(record)" class="text-[10px] text-blue-400 font-bold hover:underline">{{ t.edit }}</button>
                                                    <button @click="deleteRecord(record.id)" class="text-[10px] text-red-400 font-bold hover:underline">{{ t.del }}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-8">
                            <div class="bg-white rounded-3xl p-5 shadow-sm sticky top-4">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <span>üìä {{ t.chart_title }}</span>
                                    <span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full">{{ t.realtime }}</span>
                                </h3>
                                
                                <div class="grid gap-6" :class="hasHeadData ? 'grid-cols-1 lg:grid-cols-3' : 'grid-cols-1 lg:grid-cols-2'">
                                    <div class="bg-slate-50 p-2 rounded-2xl">
                                        <p class="text-xs font-bold text-center text-pink-500 mb-2">Weight (kg)</p>
                                        <div class="h-48 relative"><canvas id="chartWeight"></canvas></div>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-2xl">
                                        <p class="text-xs font-bold text-center text-teal-500 mb-2">Height (cm)</p>
                                        <div class="h-48 relative"><canvas id="chartHeight"></canvas></div>
                                    </div>
                                    <div v-show="hasHeadData" class="bg-slate-50 p-2 rounded-2xl">
                                        <p class="text-xs font-bold text-center text-purple-500 mb-2">Head (cm)</p>
                                        <div class="h-48 relative"><canvas id="chartHead"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showModal = false"></div>
                <div class="bg-white w-full max-w-2xl h-[85vh] sm:h-auto sm:max-h-[85vh] overflow-hidden rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col">
                    <div class="bg-gradient-to-r from-orange-400 to-pink-500 p-4 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-lg text-white">{{ t.report_title }}</h3>
                        <button @click="showModal = false" class="text-white/80 text-2xl hover:text-white">&times;</button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                        <div v-if="currentRecord && currentRecord.ai_report" v-html="marked.parse(currentRecord.ai_report)" class="prose prose-sm prose-orange text-slate-600 max-w-none"></div>
                        <div v-else class="text-center py-10 text-slate-400">{{ t.no_report_yet }}</div>

                        <div v-if="currentRecord" class="mt-8 pt-6 border-t border-slate-200 text-center">
                            <p class="text-xs text-slate-400 mb-2">{{ t.outdated_hint }}</p>
                            <button @click="regenerateReport(currentRecord)" :disabled="loading" class="bg-white border-2 border-orange-200 text-orange-500 font-bold py-2 px-6 rounded-full hover:bg-orange-50 transition">
                                {{ loading ? t.ai_thinking : t.regenerate }} ü§ñ
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-white border-t border-slate-100 shrink-0">
                        <button @click="showModal = false" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200">{{ t.close }}</button>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

        // üåç BabyUp ÂõΩÈôÖÂåñËØçÂÖ∏
        const i18n = {
            zh: {
                slogan: "ÊÇ®ÁöÑ AI ËÇ≤ÂÑø‰∏ìÂÆ∂",
                login_title: "ËæìÂÖ•È™åËØÅÁ†ÅÁôªÂΩï",
                email_label: "ÈÇÆÁÆ±Âú∞ÂùÄ",
                sending: "ÂèëÈÄÅ‰∏≠...",
                send_btn: "Ëé∑ÂèñÈ™åËØÅÁ†Å",
                code_sent_to: "È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅËá≥",
                code_label: "6 ‰ΩçÊï∞Â≠óÈ™åËØÅÁ†Å",
                verifying: "È™åËØÅ‰∏≠...",
                login_confirm: "ËøõÂÖ• BabyUp",
                back_email: "‰øÆÊîπÈÇÆÁÆ±",
                my_babies: "ÂÆùÂÆùÂàóË°®",
                logout: "ÈÄÄÂá∫",
                no_baby: "Ê¨¢ËøéÔºÅÂÖàÊ∑ªÂä†‰∏Ä‰∏™ÂÆùÂÆùÊ°£Ê°àÂêß",
                add_baby: "Ê∑ªÂä†ÂÆùÂÆù",
                add_another: "Ê∑ªÂä†‰∫åÂÆù/‰∏âÂÆù",
                back: "ËøîÂõû",
                new_profile: "Êñ∞ÂÆùÂÆùÊ°£Ê°à",
                nickname: "ÂÆùÂÆùÂ∞èÂêç",
                gender: "ÊÄßÂà´",
                boy: "üë¶ Áî∑ÂÆù",
                girl: "üëß Â•≥ÂÆù",
                birth_date: "Âá∫ÁîüÊó•Êúü",
                saving: "‰øùÂ≠ò‰∏≠...",
                create_btn: "ÂàõÂª∫Ê°£Ê°à",
                switch_baby: "ÂàáÊç¢",
                days_old: "Â§©Â§ß",
                record_entry: "üìù ‰ªäÊó•ÊàêÈïøËÆ∞ÂΩï",
                edit_mode: "‚úèÔ∏è ÁºñËæëËÆ∞ÂΩï",
                update_btn: "Êõ¥Êñ∞Êï∞ÊçÆ (‰ªÖÂõæË°®)",
                weight_ph: "‰ΩìÈáç (kg)",
                height_ph: "Ë∫´È´ò (cm)",
                head_ph: "Â§¥Âõ¥ (cm, ÈÄâÂ°´)",
                ai_thinking: "AI Ê≠£Âú®ÊÄùËÄÉ...",
                gen_report: "ÁîüÊàê AI ÊàêÈïøËß£ËØª ‚ú®",
                chart_title: "ÁîüÈïøÊõ≤Á∫ø (WHOÊ†áÂáÜ)",
                realtime: "ÂÆûÊó∂",
                history_title: "üìÖ ÂéÜÂè≤Ê°£Ê°à",
                view_report: "Êü•ÁúãÊä•Âëä",
                report_title: "AI Ê∑±Â∫¶Ëß£ËØª",
                close: "ÂÖ≥Èó≠",
                connecting: "Ê≠£Âú®ËøûÊé• BabyUp ‰∫ëÁ´Ø...",
                edit: "ÁºñËæë",
                del: "Âà†Èô§",
                no_report_yet: "ÊöÇÊó† AI Êä•Âëä",
                outdated_hint: "Êï∞ÊçÆ‰øÆÊîπÂêéÔºåÂª∫ËÆÆÈáçÊñ∞Ëß£ËØª",
                regenerate: "ÈáçÊñ∞ÁîüÊàêÊä•Âëä"
            },
            en: {
                slogan: "Your AI Parenting Expert",
                login_title: "Login with Code",
                email_label: "Email Address",
                sending: "Sending...",
                send_btn: "Get Code",
                code_sent_to: "Code sent to",
                code_label: "6-Digit Code",
                verifying: "Verifying...",
                login_confirm: "Enter BabyUp",
                back_email: "Change Email",
                my_babies: "My Babies",
                logout: "Logout",
                no_baby: "Welcome! Add a baby profile first",
                add_baby: "Add Baby",
                add_another: "Add Another Baby",
                back: "Back",
                new_profile: "New Profile",
                nickname: "Nickname",
                gender: "Gender",
                boy: "üë¶ Boy",
                girl: "üëß Girl",
                birth_date: "Birth Date",
                saving: "Saving...",
                create_btn: "Create Profile",
                switch_baby: "Switch",
                days_old: "days old",
                record_entry: "üìù Data Entry",
                edit_mode: "‚úèÔ∏è Edit Record",
                update_btn: "Update (Chart Only)",
                weight_ph: "Weight (kg)",
                height_ph: "Height (cm)",
                head_ph: "Head Circ. (cm, optional)",
                ai_thinking: "AI Thinking...",
                gen_report: "Generate AI Report ‚ú®",
                chart_title: "Growth Charts (WHO)",
                realtime: "Live",
                history_title: "üìÖ History",
                view_report: "View Report",
                report_title: "AI Insight",
                close: "Close",
                connecting: "Connecting to BabyUp...",
                edit: "Edit",
                del: "Del",
                no_report_yet: "No Report",
                outdated_hint: "Data changed? Regenerate report.",
                regenerate: "Regenerate Report"
            }
        };

        createApp({
            setup() {
                // üëá ÊõøÊç¢ÊÇ®ÁöÑ Key (Á°Æ‰øùÊòØ eyJ ÂºÄÂ§¥ÁöÑÈïø Key)
                const SUPABASE_URL = 'https://lihtuqbwilqlmxhacgeu.supabase.co'; 
                const SUPABASE_KEY = 'sb_publishable_hatyIe4q8Fr71ksOngaoig_troXToGR'; // Ê≥®ÊÑèÔºöËØ∑Á°Æ‰øùËøôÊòØÈÇ£‰∏™Èïø KeyÔºåÂ¶ÇÊûúÊòØÁü≠ÁöÑÂèØËÉΩ‰ºöÊúâÈóÆÈ¢òÔºåËØ∑Á°ÆËÆ§„ÄÇ
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                const lang = ref('zh');
                const t = computed(() => i18n[lang.value]);
                function toggleLang() { lang.value = lang.value === 'zh' ? 'en' : 'zh'; nextTick(renderCharts); }

                // Ê†∏ÂøÉÁä∂ÊÄÅ
                const user = ref(null);
                const email = ref('');
                const otpToken = ref('');
                const sentCode = ref(false);
                const loading = ref(false);
                const globalLoading = ref(true);
                
                const babies = ref([]);
                const currentBaby = ref(null);
                const showAddBabyForm = ref(false);
                const newBaby = ref({ name: '', gender: 'male', birth_date: '' });
                const records = ref([]);
                
                // ËæìÂÖ•‰∏éÁºñËæëÁä∂ÊÄÅ
                const input = ref({ date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' });
                const isEditing = ref(false);
                const editingId = ref(null);
                const percentiles = ref({ weight: '', height: '', head: '' });
                
                const showModal = ref(false);
                const currentRecord = ref(null);

                // WHO Êï∞ÊçÆ (ÁÆÄÂåñÁâà P50 ÈîöÁÇπÁî®‰∫éËÆ°ÁÆóÁôæÂàÜÊØîÂ±ïÁ§∫)
                const whoData = {
                    weight: { male: [3.3, 4.5, 5.6, 6.4, 7.0, 7.5, 7.9, 8.3, 8.6, 8.9, 9.2, 9.4, 9.6], female: [3.2, 4.2, 5.1, 5.8, 6.4, 6.9, 7.3, 7.6, 7.9, 8.2, 8.5, 8.7, 8.9] },
                    height: { male: [49.9, 54.7, 58.4, 61.4, 63.9, 65.9, 67.6, 69.2, 70.6, 72.0, 73.3, 74.5, 75.7], female: [49.1, 53.7, 57.1, 59.8, 62.1, 64.0, 65.7, 67.3, 68.7, 70.1, 71.5, 72.8, 74.0] },
                    head: { male: [34.5, 37.3, 39.1, 40.5, 41.6, 42.6, 43.5, 44.2, 44.8, 45.4, 46.0, 46.5, 47.0], female: [33.9, 36.5, 38.3, 39.5, 40.6, 41.5, 42.2, 42.8, 43.4, 44.0, 44.6, 45.1, 45.6] }
                };

                let charts = {};
                const hasHeadData = computed(() => records.value.some(r => r.head));

                // Auth: ÂèëÈÄÅÈ™åËØÅÁ†Å
                async function sendMagicCode() {
                    if (!email.value) return alert('Please enter email');
                    loading.value = true;
                    // ‰ΩøÁî® shouldCreateUser: true Á°Æ‰øùÊñ∞Áî®Êà∑‰πüËÉΩÊî∂Âà∞
                    const { error } = await supabase.auth.signInWithOtp({ email: email.value }); 
                    loading.value = false;
                    if (error) alert(error.message);
                    else sentCode.value = true;
                }

                // Auth: È™åËØÅÈ™åËØÅÁ†Å
                async function verifyOtp() {
                    loading.value = true;
                    const { data, error } = await supabase.auth.verifyOtp({ email: email.value, token: otpToken.value, type: 'email' });
                    loading.value = false;
                    if (error) alert('È™åËØÅÁ†ÅÈîôËØØÊàñÂ∑≤ËøáÊúü / Invalid Code');
                    else user.value = data.user;
                }

                async function signOut() {
                    await supabase.auth.signOut();
                    user.value = null; babies.value = []; currentBaby.value = null;
                }

                // Êï∞ÊçÆÈÄªËæë
                async function fetchBabies() {
                    const { data } = await supabase.from('babies').select('*').order('created_at', { ascending: false });
                    babies.value = data || [];
                }

                async function createBaby() {
                    if(!newBaby.value.name || !newBaby.value.birth_date) return alert('‰ø°ÊÅØ‰∏çÂÖ®');
                    loading.value = true;
                    const { error } = await supabase.from('babies').insert([{
                        user_id: user.value.id, ...newBaby.value
                    }]);
                    loading.value = false;
                    if(error) alert(error.message);
                    else { await fetchBabies(); showAddBabyForm.value = false; newBaby.value = {name:'', gender:'male', birth_date:''}; }
                }

                function selectBaby(baby) { currentBaby.value = baby; fetchRecords(baby.id); }

                async function fetchRecords(babyId) {
                    const { data } = await supabase.from('records').select('*').eq('baby_id', babyId).order('date', { ascending: false });
                    records.value = data || [];
                    nextTick(renderCharts);
                }

                // ËÆ°ÁÆóÂÆûÊó∂ÁôæÂàÜÊØî (Ëøë‰ºº‰º∞ÁÆó)
                function calcPercentiles() {
                    if (!currentBaby.value) return;
                    const birth = new Date(currentBaby.value.birth_date);
                    const now = new Date(input.value.date);
                    const month = Math.max(0, Math.min(Math.floor((now - birth)/(1000*60*60*24*30)), 12)); // ÈôêÂà∂Âú®0-12‰∏™ÊúàÂÜÖÊü•Ë°®
                    const gender = currentBaby.value.gender;
                    
                    const getPct = (type, val) => {
                        if (!val) return '';
                        const p50 = whoData[type][gender][month];
                        const diff = ((val - p50) / p50) * 100;
                        if (Math.abs(diff) < 5) return 'P50 (Ê†áÂáÜ)';
                        if (diff > 20) return '>P97 (ÂÅèÈ´ò)';
                        if (diff > 10) return 'P85 (ËæÉÈ´ò)';
                        if (diff < -20) return '<P3 (ÂÅè‰Ωé)';
                        if (diff < -10) return 'P15 (ËæÉ‰Ωé)';
                        return 'Ê≠£Â∏∏ËåÉÂõ¥';
                    };

                    percentiles.value.weight = getPct('weight', input.value.weight);
                    percentiles.value.height = getPct('height', input.value.height);
                    percentiles.value.head = getPct('head', input.value.head);
                }

                // Êèê‰∫§ËÆ∞ÂΩï (Êñ∞Â¢ûÊàñÊõ¥Êñ∞)
                async function submitRecord() {
                    if(!input.value.weight || !input.value.height) return alert('ËØ∑ËæìÂÖ•Ë∫´È´ò‰ΩìÈáç');
                    loading.value = true;
                    
                    const days = Math.ceil((new Date(input.value.date) - new Date(currentBaby.value.birth_date)) / (86400000));
                    const payload = {
                        baby_id: currentBaby.value.id,
                        date: input.value.date,
                        days,
                        weight: input.value.weight,
                        height: input.value.height,
                        head: input.value.head || null
                    };

                    try {
                        let aiReport = null;

                        // Âè™ÊúâÂú®„ÄêÊñ∞Â¢û„ÄëÊ®°Âºè‰∏ãÔºåÊâçËá™Âä®Ë∞É AI
                        if (!isEditing.value) {
                             const aiRes = await fetch('/api/analyze', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...payload, gender: currentBaby.value.gender, name: currentBaby.value.name, lang: lang.value })
                            });
                            if (aiRes.ok) { const json = await aiRes.json(); aiReport = json.result; }
                            else { aiReport = "AI ÊúçÂä°ÁπÅÂøôÔºåËØ∑Á®çÂêéÊâãÂä®ÁîüÊàê„ÄÇ"; }
                            payload.ai_report = aiReport;
                        }

                        if (isEditing.value) {
                            // Êõ¥Êñ∞Ê®°Âºè
                            const { error } = await supabase.from('records').update(payload).eq('id', editingId.value);
                            if(error) throw error;
                        } else {
                            // Êñ∞Â¢ûÊ®°Âºè
                            const { error } = await supabase.from('records').insert([payload]);
                            if(error) throw error;
                        }

                        await fetchRecords(currentBaby.value.id);
                        cancelEdit(); // ÈáçÁΩÆË°®Âçï

                    } catch(e) { alert(e.message); } 
                    finally { loading.value = false; }
                }

                // ÁºñËæëËÆ∞ÂΩï
                function editRecord(record) {
                    isEditing.value = true;
                    editingId.value = record.id;
                    input.value = { ...record }; // Â°´ÂÖÖË°®Âçï
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // ÊªöÂõûÈ°∂ÈÉ®
                    calcPercentiles();
                }

                function cancelEdit() {
                    isEditing.value = false;
                    editingId.value = null;
                    input.value = { date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' };
                    percentiles.value = { weight: '', height: '', head: '' };
                }

                // Âà†Èô§ËÆ∞ÂΩï
                async function deleteRecord(id) {
                    if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) return;
                    const { error } = await supabase.from('records').delete().eq('id', id);
                    if(!error) fetchRecords(currentBaby.value.id);
                }

                // ÈáçÊñ∞ÁîüÊàêÊä•Âëä (Option B)
                async function regenerateReport(record) {
                    loading.value = true;
                    try {
                         const aiRes = await fetch('/api/analyze', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                days: record.days, weight: record.weight, height: record.height, head: record.head,
                                gender: currentBaby.value.gender, name: currentBaby.value.name, lang: lang.value 
                            })
                        });
                        if (aiRes.ok) {
                            const json = await aiRes.json();
                            // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                            await supabase.from('records').update({ ai_report: json.result }).eq('id', record.id);
                            // Êõ¥Êñ∞ÂΩìÂâçËßÜÂõæ
                            currentRecord.value.ai_report = json.result; 
                            await fetchRecords(currentBaby.value.id); // Âà∑Êñ∞ÂàóË°®
                        }
                    } catch(e) { alert('AI Error'); }
                    finally { loading.value = false; }
                }

                function openReport(record) { currentRecord.value = record; showModal.value = true; }
                function calculateAge(d) { return Math.ceil((new Date() - new Date(d))/86400000) + ' ' + t.value.days_old; }

                // ÂõæË°®Ê∏≤Êüì (Responsive)
                function renderCharts() {
                    if(!currentBaby.value) return;
                    const ctxW = document.getElementById('chartWeight');
                    const ctxH = document.getElementById('chartHeight');
                    const ctxHead = document.getElementById('chartHead'); // ÂèØËÉΩÊòØ null Â¶ÇÊûú v-show ÈöêËóè‰∫Ü
                    
                    if(!ctxW || !ctxH) return;

                    const sorted = [...records.value].sort((a,b) => a.days - b.days);
                    const labels = sorted.map(r => `Day ${r.days}`);

                    const draw = (ctx, label, dataVals, color, stdArray) => {
                        const chartId = ctx.id;
                        if(charts[chartId]) charts[chartId].destroy();
                        
                        charts[chartId] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels.length?labels:['Birth'],
                                datasets: [
                                    { label: label, data: dataVals, borderColor: color, backgroundColor: color, tension: 0.3, borderWidth:3, pointRadius:4 },
                                    { label: 'P50 (WHO)', data: sorted.map(r => stdArray[currentBaby.value.gender][Math.min(Math.floor(r.days/30),12)]), borderColor: '#cbd5e1', borderDash:[5,5], pointRadius:0 }
                                ]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                    };

                    draw(ctxW, 'Weight', sorted.map(r=>r.weight), '#F472B6', whoData.weight);
                    draw(ctxH, 'Height', sorted.map(r=>r.height), '#2DD4BF', whoData.height);
                    if(ctxHead && sorted.some(r=>r.head)) draw(ctxHead, 'Head', sorted.map(r=>r.head), '#A78BFA', whoData.head);
                }

                onMounted(async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    user.value = session?.user || null;
                    globalLoading.value = false;
                    supabase.auth.onAuthStateChange((_, s) => { user.value = s?.user || null; if(user.value) fetchBabies(); });
                    if(user.value) fetchBabies();
                });

                return { 
                    user, email, otpToken, sentCode, loading, globalLoading,
                    babies, currentBaby, showAddBabyForm, newBaby, records, 
                    input, isEditing, percentiles, submitRecord, editRecord, cancelEdit, deleteRecord,
                    showModal, currentRecord, regenerateReport, openReport,
                    sendMagicCode, verifyOtp, signOut, createBaby, selectBaby,
                    calculateAge, lang, t, toggleLang, hasHeadData, marked, calcPercentiles
                };
            }
        }).mount('#app');
    </script>
</body>
</html>