<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FutureBaby ¬∑ AI Growth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* È´òÁßëÊäÄ+Á´•ÁúüÊÑü UI ËÆæËÆ° */
        body { 
            background: linear-gradient(135deg, #eef2ff 0%, #fce7f3 100%); 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .btn-tech {
            background: linear-gradient(90deg, #6366f1 0%, #ec4899 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        .btn-tech:active { transform: scale(0.96); }
        .input-glass {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }
        .input-glass:focus {
            background: white;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        /* ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ */
        .lang-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            color: #6366f1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-switch:hover { transform: scale(1.05); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-slate-700 min-h-screen">
    <div id="app" class="max-w-md mx-auto min-h-screen relative pb-20">
        
        <button @click="toggleLang" class="lang-switch">
            {{ lang === 'zh' ? 'üá∫üá∏ English' : 'üá®üá≥ ‰∏≠Êñá' }}
        </button>

        <div v-if="globalLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-indigo-600 font-bold">{{ t.connecting }}</p>
        </div>

        <transition name="fade">
            <div v-if="!user" class="p-6 pt-20 flex flex-col justify-center min-h-screen">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-pink-500">FutureBaby</h1>
                    <p class="text-slate-500 mt-2 font-semibold tracking-wide">{{ t.slogan }}</p>
                </div>
                
                <div class="glass-card rounded-3xl p-8">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">{{ t.login_title }}</h2>
                    <div v-if="!sentCode">
                        <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">{{ t.email_label }}</label>
                        <input type="email" v-model="email" placeholder="name@example.com" class="input-glass w-full rounded-xl p-4 outline-none mb-6">
                        <button @click="sendMagicCode" :disabled="loading" class="btn-tech w-full text-white font-bold py-4 rounded-xl">
                            {{ loading ? t.sending : t.send_btn }}
                        </button>
                    </div>
                    <div v-else>
                        <p class="text-sm text-slate-500 mb-4">{{ t.code_sent_to }} <strong>{{ email }}</strong></p>
                        <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">{{ t.code_label }}</label>
                        <input type="text" v-model="otpToken" placeholder="123456" class="input-glass w-full rounded-xl p-4 outline-none mb-6 text-center text-2xl tracking-widest font-mono">
                        <button @click="verifyOtp" :disabled="loading" class="btn-tech w-full text-white font-bold py-4 rounded-xl mb-4">
                            {{ loading ? t.verifying : t.login_confirm }}
                        </button>
                        <button @click="sentCode = false" class="w-full text-sm text-slate-400">{{ t.back_email }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user && !currentBaby && !showAddBabyForm" class="p-4 pt-12">
                <div class="flex justify-between items-center mb-8 px-2">
                    <h2 class="text-2xl font-bold text-slate-800">{{ t.my_babies }}</h2>
                    <button @click="signOut" class="text-sm text-slate-400 font-bold">{{ t.logout }}</button>
                </div>

                <div v-if="babies.length === 0" class="text-center py-20">
                    <div class="text-6xl mb-4">üê£</div>
                    <p class="text-slate-500 mb-6">{{ t.no_baby }}</p>
                    <button @click="showAddBabyForm = true" class="btn-tech text-white px-8 py-3 rounded-full font-bold shadow-lg">
                        + {{ t.add_baby }}
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div v-for="baby in babies" :key="baby.id" @click="selectBaby(baby)" class="glass-card p-5 rounded-2xl flex items-center justify-between cursor-pointer active:scale-95 transition transform">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl" :class="baby.gender === 'male' ? 'bg-blue-100' : 'bg-pink-100'">
                                {{ baby.gender === 'male' ? 'üë¶' : 'üëß' }}
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800">{{ baby.name }}</h3>
                                <p class="text-xs text-slate-500">{{ calculateAge(baby.birth_date) }}</p>
                            </div>
                        </div>
                        <div class="text-slate-300">üëâ</div>
                    </div>
                    
                    <button v-if="babies.length > 0" @click="showAddBabyForm = true" class="mt-4 w-full py-4 border-2 border-dashed border-indigo-200 text-indigo-400 rounded-2xl font-bold hover:bg-indigo-50 transition">
                        + {{ t.add_another }}
                    </button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user && showAddBabyForm" class="p-6 pt-16">
                <button @click="showAddBabyForm = false" class="text-slate-400 mb-6 font-bold">‚Üê {{ t.back }}</button>
                <h2 class="text-2xl font-bold text-slate-800 mb-6">{{ t.new_profile }}</h2>
                <div class="glass-card rounded-3xl p-6 space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">{{ t.nickname }}</label>
                        <input type="text" v-model="newBaby.name" class="input-glass w-full rounded-xl p-3 mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">{{ t.gender }}</label>
                        <div class="flex gap-4 mt-1">
                            <button @click="newBaby.gender = 'male'" :class="newBaby.gender === 'male' ? 'bg-blue-500 text-white' : 'bg-white text-slate-500'" class="flex-1 py-3 rounded-xl font-bold border transition">{{ t.boy }}</button>
                            <button @click="newBaby.gender = 'female'" :class="newBaby.gender === 'female' ? 'bg-pink-500 text-white' : 'bg-white text-slate-500'" class="flex-1 py-3 rounded-xl font-bold border transition">{{ t.girl }}</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">{{ t.birth_date }}</label>
                        <input type="date" v-model="newBaby.birth_date" class="input-glass w-full rounded-xl p-3 mt-1">
                    </div>
                    <button @click="createBaby" :disabled="loading" class="btn-tech w-full text-white font-bold py-4 rounded-xl mt-4">
                        {{ loading ? t.saving : t.create_btn }}
                    </button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user && currentBaby" class="pb-20">
                <div class="sticky top-0 z-30 bg-white/80 backdrop-blur-md px-4 py-4 shadow-sm flex justify-between items-center pt-8">
                    <button @click="currentBaby = null" class="text-slate-400 font-bold text-sm">‚Üê {{ t.switch_baby }}</button>
                    <div class="text-center">
                        <h2 class="font-bold text-slate-800">{{ currentBaby.name }}</h2>
                        <p class="text-xs text-indigo-500 font-bold">{{ calculateDays(currentBaby.birth_date) }} {{ t.days_old }}</p>
                    </div>
                    <div class="w-12"></div>
                </div>

                <div class="px-4 mt-6 space-y-6">
                    <div class="glass-card rounded-3xl p-5 border-t-4 border-indigo-500">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                            <span class="w-2 h-6 bg-indigo-500 rounded-full mr-2"></span>{{ t.record_entry }}
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" v-model="input.date" class="input-glass rounded-xl p-3 col-span-2 text-sm">
                            <input type="number" v-model="input.weight" :placeholder="t.weight_ph" class="input-glass rounded-xl p-3 text-sm">
                            <input type="number" v-model="input.height" :placeholder="t.height_ph" class="input-glass rounded-xl p-3 text-sm">
                            <input type="number" v-model="input.head" :placeholder="t.head_ph" class="input-glass rounded-xl p-3 text-sm col-span-2">
                        </div>
                        <button @click="submitRecord" :disabled="loading" class="btn-tech w-full text-white font-bold py-3 rounded-xl mt-4 shadow-md flex justify-center items-center gap-2">
                            <span v-if="loading" class="animate-spin">‚è≥</span>
                            <span>{{ loading ? t.ai_thinking : t.gen_report }}</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-3xl p-5 shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                            <div class="flex items-center"><span class="w-2 h-6 bg-pink-500 rounded-full mr-2"></span>{{ t.chart_title }}</div>
                            <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">{{ t.realtime }}</span>
                        </h3>
                        
                        <div class="space-y-6">
                            <div>
                                <p class="text-xs font-bold text-center text-pink-500 mb-1">{{ t.chart_weight }}</p>
                                <div class="h-48 relative"><canvas id="chartWeight"></canvas></div>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-center text-teal-500 mb-1">{{ t.chart_height }}</p>
                                <div class="h-48 relative"><canvas id="chartHeight"></canvas></div>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-center text-purple-500 mb-1">{{ t.chart_head }}</p>
                                <div class="h-48 relative"><canvas id="chartHead"></canvas></div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h3 class="font-bold text-slate-700 ml-2">{{ t.history_title }}</h3>
                        <div v-for="record in records" :key="record.id" class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-slate-50">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-700">{{ record.date }}</span>
                                    <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold">Day {{ record.days }}</span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1 space-x-2">
                                    <span>‚öñÔ∏è {{ record.weight }}kg</span>
                                    <span>üìè {{ record.height }}cm</span>
                                </div>
                            </div>
                            <button @click="openReport(record.ai_report)" class="text-xs bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg font-bold hover:bg-indigo-100">
                                {{ t.view_report }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showModal = false"></div>
                <div class="bg-white w-full max-w-lg h-[85vh] sm:h-auto sm:max-h-[85vh] overflow-hidden rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-lg text-white">{{ t.report_title }}</h3>
                        <button @click="showModal = false" class="text-white/80 text-2xl hover:text-white">&times;</button>
                    </div>
                    <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                        <div v-html="currentReportHtml" class="prose prose-sm prose-indigo text-slate-600"></div>
                    </div>
                    <div class="p-4 bg-white border-t border-slate-100 shrink-0">
                        <button @click="showModal = false" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200">{{ t.close }}</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

        // üåç ÂõΩÈôÖÂåñËØçÂÖ∏ (Language Dictionary)
        const i18n = {
            zh: {
                slogan: "AI È©±Âä®ÁöÑÊô∫ËÉΩÊàêÈïø‰∏≠ÂøÉ",
                login_title: "‚ú® ÂºÄÂêØÊé¢Á¥¢‰πãÊóÖ",
                email_label: "ÊÇ®ÁöÑÈÇÆÁÆ±",
                sending: "ÂèëÈÄÅ‰∏≠...",
                send_btn: "ÂèëÈÄÅÈ™åËØÅÁ†Å üöÄ",
                code_sent_to: "È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅËá≥",
                code_label: "ËØ∑ËæìÂÖ• 6 ‰ΩçÈ™åËØÅÁ†Å",
                verifying: "È™åËØÅ‰∏≠...",
                login_confirm: "ËøõÂÖ•Á≥ªÁªü ‚ú®",
                back_email: "ËøîÂõû‰øÆÊîπÈÇÆÁÆ±",
                my_babies: "ÊàëÁöÑÂÆùÂÆùÊ°£Ê°à",
                logout: "ÈÄÄÂá∫",
                no_baby: "ËøòÊ≤°ÊúâÂÆùÂÆùÊ°£Ê°àÂì¶",
                add_baby: "Ê∑ªÂä†ÂÆùÂÆù",
                add_another: "Ê∑ªÂä†Âè¶‰∏Ä‰∏™ÂÆùÂÆù",
                back: "ËøîÂõû",
                new_profile: "Êñ∞Ê°£Ê°àÂΩïÂÖ•",
                nickname: "ÂÆùÂÆùÊòµÁß∞",
                gender: "ÊÄßÂà´",
                boy: "üë¶ Áî∑ÂÆù",
                girl: "üëß Â•≥ÂÆù",
                birth_date: "Âá∫ÁîüÊó•Êúü",
                saving: "ÂàõÂª∫‰∏≠...",
                create_btn: "Á°ÆËÆ§ÂàõÂª∫ ‚úÖ",
                switch_baby: "ÂàáÊç¢ÂÆùÂÆù",
                days_old: "Â§©",
                record_entry: "‰ªäÊó•Êï∞ÊçÆÂΩïÂÖ•",
                weight_ph: "‰ΩìÈáç kg",
                height_ph: "Ë∫´È´ò cm",
                head_ph: "Â§¥Âõ¥ cm (ÈÄâÂ°´)",
                ai_thinking: "AI ÂàÜÊûê‰∏≠...",
                gen_report: "ÁîüÊàê AI Ê∑±Â∫¶Ëß£ËØª ‚ú®",
                chart_title: "ÁîüÈïøÊõ≤Á∫ø (WHO)",
                realtime: "ÂÆûÊó∂Êõ¥Êñ∞",
                chart_weight: "‰ΩìÈáçÊõ≤Á∫ø (Weight)",
                chart_height: "Ë∫´ÈïøÊõ≤Á∫ø (Height)",
                chart_head: "Â§¥Âõ¥Êõ≤Á∫ø (Head)",
                history_title: "üìÖ ÂéÜÂè≤Ê°£Ê°à",
                view_report: "Êü•ÁúãÊä•Âëä",
                report_title: "ü©∫ AI ‰∏ìÂÆ∂Ëß£ËØª",
                close: "ÂÖ≥Èó≠",
                connecting: "Ê≠£Âú®ËøûÊé•‰∫ëÁ´Ø..."
            },
            en: {
                slogan: "AI-Powered Baby Growth Assistant",
                login_title: "‚ú® Start Your Journey",
                email_label: "Your Email",
                sending: "Sending...",
                send_btn: "Send Code üöÄ",
                code_sent_to: "Code sent to",
                code_label: "Enter 6-digit Code",
                verifying: "Verifying...",
                login_confirm: "Login ‚ú®",
                back_email: "Change Email",
                my_babies: "My Babies",
                logout: "Sign Out",
                no_baby: "No baby profiles yet",
                add_baby: "Add Baby",
                add_another: "Add Another Baby",
                back: "Back",
                new_profile: "New Profile",
                nickname: "Nickname",
                gender: "Gender",
                boy: "üë¶ Boy",
                girl: "üëß Girl",
                birth_date: "Birth Date",
                saving: "Saving...",
                create_btn: "Create Profile ‚úÖ",
                switch_baby: "Switch",
                days_old: "days old",
                record_entry: "Data Entry",
                weight_ph: "Weight (kg)",
                height_ph: "Height (cm)",
                head_ph: "Head Circ. (cm)",
                ai_thinking: "Analyzing...",
                gen_report: "Generate AI Insight ‚ú®",
                chart_title: "Growth Charts (WHO)",
                realtime: "Live",
                chart_weight: "Weight Curve",
                chart_height: "Height Curve",
                chart_head: "Head Circ. Curve",
                history_title: "üìÖ History",
                view_report: "View Report",
                report_title: "ü©∫ AI Expert Insight",
                close: "Close",
                connecting: "Connecting to Cloud..."
            }
        };

        createApp({
            setup() {
                // ============================================
                // üëá ËØ∑Âä°ÂøÖÊõøÊç¢ÊÇ®ÁöÑ Supabase URL Âíå Key üëá
                // ============================================
                const SUPABASE_URL = 'VITE_SUPBASE_URL=https://lihtuqbwilqlmxhacgeu.supabase.co'; 
                const SUPABASE_KEY = 'VITE_SUPBASE_KEY=sb_publishable_hatyIe4q8Fr71ksOngaoig_troXToGR';
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // ËØ≠Ë®ÄÁä∂ÊÄÅ
                const lang = ref('zh'); // ÈªòËÆ§‰∏≠Êñá
                const t = computed(() => i18n[lang.value]);

                function toggleLang() {
                    lang.value = lang.value === 'zh' ? 'en' : 'zh';
                    // ÂàáÊç¢ËØ≠Ë®ÄÂêéÔºåÂ¶ÇÊûúÂõæË°®Â≠òÂú®ÔºåÂà∑Êñ∞‰∏Ä‰∏ãÂõæË°®Ê†áÈ¢ò
                    nextTick(renderCharts);
                }

                // Áä∂ÊÄÅÂèòÈáè
                const user = ref(null);
                const email = ref('');
                const otpToken = ref('');
                const sentCode = ref(false);
                const loading = ref(false);
                const globalLoading = ref(true);
                
                const babies = ref([]);
                const currentBaby = ref(null);
                const showAddBabyForm = ref(false);
                const newBaby = ref({ name: '', gender: 'male', birth_date: '' });
                
                const records = ref([]);
                const input = ref({ date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' });
                
                const showModal = ref(false);
                const currentReportHtml = ref('');

                // WHO Êï∞ÊçÆ
                const whoStandards = {
                    weight: { male: [3.3, 4.5, 5.6, 6.4, 7.0, 7.5, 7.9], female: [3.2, 4.2, 5.1, 5.8, 6.4, 6.9, 7.3] },
                    height: { male: [49.9, 54.7, 58.4, 61.4, 63.9, 65.9, 67.6], female: [49.1, 53.7, 57.1, 59.8, 62.1, 64.0, 65.7] },
                    head: { male: [34.5, 37.3, 39.1, 40.5, 41.6, 42.6, 43.5], female: [33.9, 36.5, 38.3, 39.5, 40.6, 41.5, 42.2] }
                };

                let charts = {};

                // --- Ê†∏ÂøÉÈÄªËæë ---

                async function sendMagicCode() {
                    if (!email.value) return alert('Please enter email / ËØ∑ËæìÂÖ•ÈÇÆÁÆ±');
                    loading.value = true;
                    const { error } = await supabase.auth.signInWithOtp({ email: email.value });
                    loading.value = false;
                    if (error) alert(error.message);
                    else sentCode.value = true;
                }

                async function verifyOtp() {
                    loading.value = true;
                    const { data, error } = await supabase.auth.verifyOtp({ email: email.value, token: otpToken.value, type: 'email' });
                    loading.value = false;
                    if (error) alert('Error / È™åËØÅÁ†ÅÈîôËØØ');
                    else user.value = data.user;
                }

                async function signOut() {
                    await supabase.auth.signOut();
                    user.value = null;
                    babies.value = [];
                    currentBaby.value = null;
                }

                async function fetchBabies() {
                    const { data } = await supabase.from('babies').select('*').order('created_at', { ascending: false });
                    babies.value = data || [];
                }

                async function createBaby() {
                    if(!newBaby.value.name || !newBaby.value.birth_date) return alert('Incomplete Info / ‰ø°ÊÅØ‰∏çÂÖ®');
                    loading.value = true;
                    const { error } = await supabase.from('babies').insert([{
                        user_id: user.value.id,
                        name: newBaby.value.name,
                        gender: newBaby.value.gender,
                        birth_date: newBaby.value.birth_date
                    }]);
                    if(error) alert(error.message);
                    else {
                        await fetchBabies();
                        showAddBabyForm.value = false;
                        newBaby.value = { name: '', gender: 'male', birth_date: '' };
                    }
                    loading.value = false;
                }

                function selectBaby(baby) {
                    currentBaby.value = baby;
                    fetchRecords(baby.id);
                }

                async function fetchRecords(babyId) {
                    const { data } = await supabase.from('records').select('*').eq('baby_id', babyId).order('date', { ascending: false });
                    records.value = data || [];
                    nextTick(renderCharts);
                }

                async function submitRecord() {
                    if(!input.value.weight || !input.value.height) return alert('Please enter weight & height / ËØ∑Â°´ÂÜô‰ΩìÈáçË∫´È´ò');
                    loading.value = true;
                    
                    const birth = new Date(currentBaby.value.birth_date);
                    const recordDate = new Date(input.value.date);
                    const days = Math.ceil((recordDate - birth) / (1000 * 60 * 60 * 24));
                    
                    try {
                        // ü§ñ Ë∞ÉÁî® AI: ‰º†ÈÄí lang ÂèÇÊï∞
                        const aiRes = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                days, 
                                weight: input.value.weight, 
                                height: input.value.height,
                                head: input.value.head,
                                gender: currentBaby.value.gender,
                                name: currentBaby.value.name,
                                lang: lang.value // üëà ÂÖ≥ÈîÆÔºöÂëäËØâÂêéÁ´ØÂΩìÂâçÊòØ‰∏≠ÊñáËøòÊòØËã±Êñá
                            })
                        });
                        
                        let aiReportResult = "";
                        // Â§ÑÁêÜÂèØËÉΩÁöÑ AI ÈîôËØØÔºå‰∏çÈòªÊñ≠‰øùÂ≠ò
                        if (aiRes.ok) {
                            const aiData = await aiRes.json();
                            aiReportResult = aiData.result;
                        } else {
                            aiReportResult = lang.value === 'en' ? "AI is busy, saved data only." : "‰∏ìÂÆ∂ÂøôÁ¢åÔºå‰ªÖ‰øùÂ≠òÊï∞ÊçÆ„ÄÇ";
                        }

                        const { error } = await supabase.from('records').insert([{
                            baby_id: currentBaby.value.id,
                            date: input.value.date,
                            days,
                            weight: input.value.weight,
                            height: input.value.height,
                            head: input.value.head ? input.value.head : null,
                            ai_report: aiReportResult
                        }]);

                        if(error) throw error;
                        
                        await fetchRecords(currentBaby.value.id);
                        openReport(aiReportResult);
                        
                        // Ê∏ÖÁ©∫ËæìÂÖ• (‰øùÁïôÊó•Êúü)
                        input.value.weight = '';
                        input.value.height = '';
                        input.value.head = '';

                    } catch(e) {
                        alert('Error: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                }

                function renderCharts() {
                    if(!currentBaby.value) return;
                    const ctxW = document.getElementById('chartWeight');
                    const ctxH = document.getElementById('chartHeight');
                    const ctxHead = document.getElementById('chartHead');
                    if(!ctxW || !ctxH) return;

                    const sorted = [...records.value].sort((a,b) => a.days - b.days);
                    const labels = sorted.map(r => `Day ${r.days}`);
                    
                    // ‰ΩøÁî® t.value Êù•Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÁöÑÂõæË°®Ê†áÈ¢ò
                    const createChart = (ctx, label, data, color, stdData) => {
                        const chartId = ctx.id;
                        if(charts[chartId]) charts[chartId].destroy();

                        charts[chartId] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels.length ? labels : ['Birth'],
                                datasets: [
                                    {
                                        label: `${currentBaby.value.name} ${label}`,
                                        data: data,
                                        borderColor: color,
                                        backgroundColor: color,
                                        borderWidth: 3,
                                        pointRadius: 4,
                                        tension: 0.3
                                    },
                                    {
                                        label: `WHO (50%)`,
                                        data: sorted.map(r => {
                                            const month = Math.min(Math.floor(r.days/30), 6);
                                            return stdData[currentBaby.value.gender][month];
                                        }),
                                        borderColor: '#cbd5e1',
                                        borderDash: [5,5],
                                        borderWidth: 2,
                                        pointRadius: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom' } }
                            }
                        });
                    };

                    // ËøôÈáåÂä®ÊÄÅ‰º†ÂÖ•ÁøªËØëÂêéÁöÑÊ†áÁ≠æ
                    createChart(ctxW, lang.value === 'zh' ? '‰ΩìÈáç' : 'Weight', sorted.map(r => r.weight), '#ec4899', whoStandards.weight);
                    createChart(ctxH, lang.value === 'zh' ? 'Ë∫´È´ò' : 'Height', sorted.map(r => r.height), '#14b8a6', whoStandards.height);
                    createChart(ctxHead, lang.value === 'zh' ? 'Â§¥Âõ¥' : 'Head', sorted.map(r => r.head), '#8b5cf6', whoStandards.head);
                }

                function calculateAge(birthDate) {
                    const days = Math.ceil((new Date() - new Date(birthDate)) / (1000 * 60 * 60 * 24));
                    return `${days} ${t.value.days_old}`;
                }
                function calculateDays(birthDate) { 
                    const days = Math.ceil((new Date() - new Date(birthDate)) / (1000 * 60 * 60 * 24));
                    return days;
                }
                function openReport(html) { currentReportHtml.value = marked.parse(html || ''); showModal.value = true; }

                onMounted(async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    user.value = session?.user || null;
                    globalLoading.value = false;
                    
                    supabase.auth.onAuthStateChange((_, session) => {
                        user.value = session?.user || null;
                        if(user.value) fetchBabies();
                    });

                    if(user.value) fetchBabies();
                });

                return { 
                    user, email, otpToken, sentCode, loading, globalLoading,
                    babies, currentBaby, showAddBabyForm, newBaby,
                    records, input, showModal, currentReportHtml,
                    sendMagicCode, verifyOtp, signOut,
                    createBaby, selectBaby, submitRecord, openReport,
                    calculateAge, calculateDays,
                    lang, t, toggleLang // ÂØºÂá∫ËØ≠Ë®ÄÊéßÂà∂
                };
            }
        }).mount('#app');
    </script>
</body>
</html>