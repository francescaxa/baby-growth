<!DOCTYPE html>
<html :lang="lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BabyUp Â· æ™ºèƒ½æˆé•¿åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #FFF0F5 0%, #E0F7FA 100%); font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        .btn-brand { background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); transition: all 0.2s; }
        .btn-brand:active { transform: scale(0.96); }
        .input-glass { background: rgba(255, 255, 255, 0.8); border: 2px solid #F3F4F6; transition: all 0.3s; }
        .input-glass:focus { background: white; border-color: #FF8E53; box-shadow: 0 0 0 3px rgba(255, 142, 83, 0.1); }
        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 100; background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px; font-weight: 800; color: #FF6B6B; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .lang-switch:hover { transform: scale(1.05); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* ğŸ“ AI æŠ¥å‘Šç²¾ç¾æ’ç‰ˆ CSS (è§£å†³æ˜Ÿå·å’Œæ ¼å¼é—®é¢˜) */
        .report-content h1, .report-content h2, .report-content h3 { color: #EA580C; font-weight: 800; margin-top: 1.5em; margin-bottom: 0.5em; }
        .report-content strong { color: #0f172a; font-weight: 800; background: linear-gradient(120deg, #ffedd5 0%, #ffedd5 100%); background-repeat: no-repeat; background-size: 100% 40%; background-position: 0 88%; }
        .report-content p { line-height: 1.8; margin-bottom: 1.2em; color: #334155; font-size: 0.95rem; text-align: justify; }
        .report-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        .report-content li { margin-bottom: 0.5em; color: #475569; }
        .report-content blockquote { border-left: 4px solid #FDBA74; padding-left: 1em; color: #64748b; font-style: italic; background: #fff7ed; padding: 10px; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body class="text-slate-700 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto min-h-screen relative pb-20">
        
        <button @click="toggleLang" class="lang-switch">{{ lang === 'zh' ? 'ğŸ‡ºğŸ‡¸ English' : 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡' }}</button>

        <div v-if="globalLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/95 backdrop-blur-md">
            <div class="animate-bounce text-6xl mb-6">ğŸ‘¶</div>
            <p class="text-slate-500 font-bold tracking-widest text-lg">BabyUp Loading...</p>
        </div>

        <transition name="fade">
            <div v-if="!user" class="p-6 pt-20 flex flex-col items-center justify-center min-h-screen max-w-md mx-auto">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400">BabyUp</h1>
                    <p class="text-slate-400 mt-2 font-bold tracking-wide text-sm uppercase">{{ t.slogan }}</p>
                </div>
                <div class="glass-card rounded-3xl p-8 w-full">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">{{ t.login_title }}</h2>
                    <div v-if="!sentCode">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">{{ t.email_label }}</label>
                        <input type="email" v-model="email" placeholder="name@example.com" class="input-glass w-full rounded-xl p-4 outline-none mb-6">
                        <button @click="sendMagicCode" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-xl">{{ loading ? t.sending : t.send_btn }}</button>
                    </div>
                    <div v-else>
                        <p class="text-sm text-slate-500 mb-4">{{ t.code_sent_to }} <strong class="text-orange-500">{{ email }}</strong></p>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">{{ t.code_label }}</label>
                        <input type="text" v-model="otpToken" placeholder="123456" maxlength="6" class="input-glass w-full rounded-xl p-4 outline-none mb-6 text-center text-3xl tracking-[0.5em] font-mono font-bold text-slate-700">
                        <button @click="verifyOtp" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl mb-4 shadow-xl">{{ loading ? t.verifying : t.login_confirm }}</button>
                        <button @click="sentCode = false" class="w-full text-sm text-slate-400 hover:text-orange-500">{{ t.back_email }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user" class="p-4 pt-4">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-2">
                         <span class="text-2xl font-extrabold text-orange-500 tracking-tight">BabyUp</span>
                         <span v-if="currentBaby" class="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold border border-orange-200">{{ currentBaby.name }}</span>
                    </div>
                    <div class="flex gap-4 text-sm font-bold text-slate-400">
                        <button v-if="currentBaby" @click="currentBaby = null" class="hover:text-slate-600 transition">{{ t.switch_baby }}</button>
                        <button @click="signOut" class="hover:text-red-500 transition">{{ t.logout }}</button>
                    </div>
                </div>

                <div v-if="!currentBaby && !showAddBabyForm" class="max-w-md mx-auto">
                    <div v-if="babies.length === 0" class="text-center py-20">
                        <div class="text-6xl mb-4">ğŸ£</div>
                        <p class="text-slate-500 mb-6 font-bold">{{ t.no_baby }}</p>
                        <button @click="showAddBabyForm = true" class="btn-brand text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition">+ {{ t.add_baby }}</button>
                    </div>
                    <div v-else class="grid gap-4">
                        <div v-for="baby in babies" :key="baby.id" @click="selectBaby(baby)" class="glass-card p-5 rounded-2xl flex items-center justify-between cursor-pointer hover:scale-[1.02] transition transform duration-200 hover:shadow-md">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-inner" :class="baby.gender === 'male' ? 'bg-blue-100' : 'bg-pink-100'">{{ baby.gender === 'male' ? 'ğŸ‘¦' : 'ğŸ‘§' }}</div>
                                <div><h3 class="font-bold text-lg text-slate-800">{{ baby.name }}</h3><p class="text-xs text-slate-500 font-bold">{{ calculateAge(baby.birth_date) }}</p></div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">âœ</div>
                        </div>
                        <button @click="showAddBabyForm = true" class="mt-4 w-full py-4 border-2 border-dashed border-slate-300 text-slate-400 rounded-2xl font-bold hover:border-orange-300 hover:text-orange-500 transition hover:bg-orange-50">+ {{ t.add_another }}</button>
                    </div>
                </div>

                <div v-if="showAddBabyForm" class="max-w-md mx-auto pt-10">
                    <button @click="showAddBabyForm = false" class="text-slate-400 mb-6 font-bold flex items-center gap-1 hover:text-slate-600 transition">â† {{ t.back }}</button>
                    <div class="glass-card rounded-3xl p-6 space-y-4">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">{{ t.new_profile }}</h2>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">{{ t.nickname }}</label><input type="text" v-model="newBaby.name" class="input-glass w-full rounded-xl p-3 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">{{ t.gender }}</label>
                            <div class="flex gap-4 mt-1">
                                <button @click="newBaby.gender = 'male'" :class="newBaby.gender === 'male' ? 'bg-blue-500 text-white ring-2 ring-blue-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.boy }}</button>
                                <button @click="newBaby.gender = 'female'" :class="newBaby.gender === 'female' ? 'bg-pink-500 text-white ring-2 ring-pink-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.girl }}</button>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">{{ t.birth_date }}</label><input type="date" :lang="lang === 'en' ? 'en-US' : 'zh-CN'" v-model="newBaby.birth_date" class="input-glass w-full rounded-xl p-3 mt-1"></div>
                        <button @click="createBaby" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl mt-4 shadow-xl">{{ loading ? t.saving : t.create_btn }}</button>
                    </div>
                </div>

                <div v-if="currentBaby" class="pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        
                        <div class="md:col-span-4 space-y-6">
                            <div class="glass-card rounded-3xl p-5 border-l-4 border-orange-400 relative transition-all duration-300" :class="isEditing ? 'ring-2 ring-orange-200 shadow-xl' : ''">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                    <span>{{ isEditing ? t.edit_mode : t.record_entry }}</span>
                                    <button v-if="isEditing" @click="cancelEdit" class="text-xs text-red-500 bg-red-100 px-3 py-1 rounded-full font-bold hover:bg-red-200 transition">Cancel</button>
                                </h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <input type="date" :lang="lang === 'en' ? 'en-US' : 'zh-CN'" v-model="input.date" class="input-glass rounded-xl p-3 text-sm font-bold text-slate-600">
                                    <div class="relative"><input type="number" v-model="input.weight" :placeholder="t.weight_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-orange-400 bg-orange-50 px-2 py-1 rounded">{{ percentiles.weight }}</span></div>
                                    <div class="relative"><input type="number" v-model="input.height" :placeholder="t.height_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-teal-500 bg-teal-50 px-2 py-1 rounded">{{ percentiles.height }}</span></div>
                                    <div class="relative"><input type="number" v-model="input.head" :placeholder="t.head_ph" @input="calcPercentiles" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">{{ percentiles.head }}</span></div>
                                </div>
                                <button @click="submitRecord" :disabled="loading" class="btn-brand w-full text-white font-bold py-3 rounded-xl mt-4 shadow-lg flex justify-center items-center gap-2 transform active:scale-95 transition">
                                    <span v-if="loading" class="animate-spin">â³</span><span>{{ isEditing ? t.update_btn : t.gen_report }}</span>
                                </button>
                            </div>
                            <div class="bg-white/60 rounded-3xl p-5 max-h-[500px] overflow-y-auto border border-white shadow-sm">
                                <h3 class="font-bold text-slate-700 mb-3 ml-1">{{ t.history_title }}</h3>
                                <div class="space-y-3 pr-1">
                                    <div v-for="record in records" :key="record.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group relative overflow-hidden">
                                        <div v-if="isEditing && editingId === record.id" class="absolute left-0 top-0 bottom-0 w-1 bg-orange-400"></div>
                                        
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-bold text-slate-800 text-sm">{{ record.date }}</span>
                                                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">Day {{ record.days }}</span>
                                                </div>
                                                <div class="text-xs text-slate-500 space-x-2">
                                                    <span class="font-bold text-pink-500">{{ record.weight }}kg</span><span class="font-bold text-teal-500">{{ record.height }}cm</span><span v-if="record.head" class="text-purple-400">{{ record.head }}cm</span>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2 text-right">
                                                <button @click="openReport(record)" class="text-[10px] bg-orange-50 text-orange-500 px-3 py-1.5 rounded-lg font-bold hover:bg-orange-100 transition">{{ record.ai_report ? t.view_report_btn : t.gen_report_btn }}</button>
                                                <div class="flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button @click="editRecord(record)" class="text-[10px] text-blue-400 font-bold hover:underline">{{ t.edit }}</button>
                                                    <button @click="deleteRecord(record.id)" class="text-[10px] text-red-400 font-bold hover:underline">{{ t.del }}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-8">
                            <div class="bg-white rounded-3xl p-6 shadow-sm sticky top-4 min-h-[600px] flex flex-col border border-slate-100">
                                <h3 class="font-bold text-slate-700 mb-6 flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span>ğŸ“Š {{ t.chart_title }}</span></div>
                                    <div class="flex bg-slate-100 p-1 rounded-lg">
                                        <button @click="changeStandard('who')" :class="standard === 'who' ? 'bg-white shadow text-orange-500' : 'text-slate-400'" class="text-xs font-bold px-3 py-1.5 rounded-md transition-all">WHO</button>
                                        <button @click="changeStandard('china')" :class="standard === 'china' ? 'bg-white shadow text-red-500' : 'text-slate-400'" class="text-xs font-bold px-3 py-1.5 rounded-md transition-all">China (2022)</button>
                                    </div>
                                </h3>
                                
                                <div class="grid gap-8 flex-1" :class="hasHeadData ? 'grid-cols-1 lg:grid-cols-3' : 'grid-cols-1 lg:grid-cols-2'">
                                    <div class="bg-slate-50 p-3 rounded-2xl flex flex-col hover:shadow-inner transition"><p class="text-xs font-bold text-center text-pink-500 mb-2">ä½“é‡ / Weight (kg)</p><div class="flex-1 min-h-[256px] relative"><canvas id="chartWeight"></canvas></div></div>
                                    <div class="bg-slate-50 p-3 rounded-2xl flex flex-col hover:shadow-inner transition"><p class="text-xs font-bold text-center text-teal-500 mb-2">èº«é«˜ / Height (cm)</p><div class="flex-1 min-h-[256px] relative"><canvas id="chartHeight"></canvas></div></div>
                                    <div v-show="hasHeadData" class="bg-slate-50 p-3 rounded-2xl flex flex-col hover:shadow-inner transition"><p class="text-xs font-bold text-center text-purple-500 mb-2">å¤´å›´ / Head (cm)</p><div class="flex-1 min-h-[256px] relative"><canvas id="chartHead"></canvas></div></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showModal = false"></div>
                <div class="bg-white w-full max-w-2xl h-[90vh] sm:h-auto sm:max-h-[90vh] overflow-hidden rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col">
                    <div class="bg-gradient-to-r from-orange-400 to-pink-500 p-4 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-lg text-white flex items-center gap-2"><span class="text-2xl">ğŸ©º</span> {{ t.report_title }}</h3>
                        <button @click="showModal = false" class="text-white/80 text-2xl hover:text-white transition">&times;</button>
                    </div>
                    <div class="p-8 overflow-y-auto flex-1 bg-slate-50 report-content"> <div v-if="currentRecord && currentRecord.ai_report" v-html="renderMarkdown(currentRecord.ai_report)" class="text-slate-700 max-w-none leading-relaxed"></div>
                        <div v-else class="text-center py-20">
                            <div class="text-6xl mb-4 text-slate-200">ğŸ“„</div>
                            <p class="text-slate-400 font-bold">{{ t.no_report_yet }}</p>
                        </div>

                        <div v-if="currentRecord" class="mt-8 pt-6 border-t border-slate-200 text-center">
                            <p class="text-xs text-slate-400 mb-2">{{ t.outdated_hint }}</p>
                            <button @click="regenerateReport(currentRecord)" :disabled="loading" class="bg-white border-2 border-orange-200 text-orange-500 font-bold py-2 px-6 rounded-full hover:bg-orange-50 transition shadow-sm">{{ loading ? t.ai_thinking : t.regenerate }} ğŸ¤–</button>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t border-slate-100 shrink-0"><button @click="showModal = false" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 transition">{{ t.close }}</button></div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

        const i18n = {
            zh: { slogan: "æ‚¨çš„ AI è‚²å„¿ä¸“å®¶", login_title: "è¾“å…¥éªŒè¯ç ç™»å½•", email_label: "é‚®ç®±åœ°å€", sending: "å‘é€ä¸­...", send_btn: "è·å–éªŒè¯ç ", code_sent_to: "éªŒè¯ç å·²å‘é€è‡³", code_label: "6 ä½æ•°å­—éªŒè¯ç ", verifying: "éªŒè¯ä¸­...", login_confirm: "è¿›å…¥ BabyUp", back_email: "ä¿®æ”¹é‚®ç®±", my_babies: "å®å®åˆ—è¡¨", logout: "é€€å‡º", no_baby: "æ¬¢è¿ï¼å…ˆæ·»åŠ ä¸€ä¸ªå®å®æ¡£æ¡ˆå§", add_baby: "æ·»åŠ å®å®", add_another: "æ·»åŠ äºŒå®/ä¸‰å®", back: "è¿”å›", new_profile: "æ–°å®å®æ¡£æ¡ˆ", nickname: "å®å®å°å", gender: "æ€§åˆ«", boy: "ğŸ‘¦ ç”·å®", girl: "ğŸ‘§ å¥³å®", birth_date: "å‡ºç”Ÿæ—¥æœŸ", saving: "ä¿å­˜ä¸­...", create_btn: "åˆ›å»ºæ¡£æ¡ˆ", switch_baby: "åˆ‡æ¢", days_old: "å¤©å¤§", record_entry: "ğŸ“ ä»Šæ—¥æˆé•¿è®°å½•", edit_mode: "âœï¸ ç¼–è¾‘è®°å½• (ä¿®æ”¹åè‡ªåŠ¨åŒæ­¥)", update_btn: "ä¿å­˜å¹¶æ›´æ–°å›¾è¡¨", weight_ph: "ä½“é‡ (kg)", height_ph: "èº«é«˜ (cm)", head_ph: "å¤´å›´ (cm, é€‰å¡«)", ai_thinking: "AI ä¸“å®¶æ€è€ƒä¸­...", gen_report: "ç”Ÿæˆ AI æˆé•¿è§£è¯» âœ¨", chart_title: "ç”Ÿé•¿æ›²çº¿", realtime: "å®æ—¶", history_title: "ğŸ“… å†å²æ¡£æ¡ˆ", view_report_btn: "ğŸ“„ æŸ¥çœ‹æŠ¥å‘Š", gen_report_btn: "âœ¨ ç”ŸæˆæŠ¥å‘Š", report_title: "AI æ·±åº¦è§£è¯»", close: "å…³é—­", connecting: "æ­£åœ¨è¿æ¥ BabyUp äº‘ç«¯...", edit: "ç¼–è¾‘", del: "åˆ é™¤", no_report_yet: "æš‚æ—  AI æŠ¥å‘Š", outdated_hint: "æ•°æ®æ›´æ–°åï¼Œå¯é‡æ–°è§£è¯»", regenerate: "é‡æ–°ç”ŸæˆæŠ¥å‘Š" },
            en: { slogan: "Your AI Parenting Expert", login_title: "Login with Code", email_label: "Email Address", sending: "Sending...", send_btn: "Get Code", code_sent_to: "Code sent to", code_label: "6-Digit Code", verifying: "Verifying...", login_confirm: "Enter BabyUp", back_email: "Change Email", my_babies: "My Babies", logout: "Logout", no_baby: "Welcome! Add a baby profile first", add_baby: "Add Baby", add_another: "Add Another Baby", back: "Back", new_profile: "New Profile", nickname: "Nickname", gender: "Gender", boy: "ğŸ‘¦ Boy", girl: "ğŸ‘§ Girl", birth_date: "Birth Date", saving: "Saving...", create_btn: "Create Profile", switch_baby: "Switch", days_old: "days old", record_entry: "ğŸ“ Data Entry", edit_mode: "âœï¸ Edit Record", update_btn: "Save & Update Charts", weight_ph: "Weight (kg)", height_ph: "Height (cm)", head_ph: "Head Circ. (cm, optional)", ai_thinking: "AI Thinking...", gen_report: "Generate AI Report âœ¨", chart_title: "Growth Charts", realtime: "Live", history_title: "ğŸ“… History", view_report_btn: "ğŸ“„ View Report", gen_report_btn: "âœ¨ AI Report", report_title: "AI Insight", close: "Close", connecting: "Connecting to BabyUp...", edit: "Edit", del: "Del", no_report_yet: "No Report", outdated_hint: "Data changed? Regenerate report.", regenerate: "Regenerate Report" }
        };

        createApp({
            setup() {
                // ğŸ‘‡ æ›¿æ¢æ‚¨çš„ Key
                const SUPABASE_URL = 'https://lihtuqbwilqlmxhacgeu.supabase.co'; 
                const SUPABASE_KEY = 'sb_publishable_hatyIe4q8Fr71ksOngaoig_troXToGR';
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const lang = ref('zh'); const t = computed(() => i18n[lang.value]);
                function toggleLang() { lang.value = lang.value === 'zh' ? 'en' : 'zh'; nextTick(() => { calcPercentiles(); renderCharts(); }); }

                const user = ref(null); const email = ref(''); const otpToken = ref(''); const sentCode = ref(false); const loading = ref(false); const globalLoading = ref(true);
                const babies = ref([]); const currentBaby = ref(null); const showAddBabyForm = ref(false); const newBaby = ref({ name: '', gender: 'male', birth_date: '' });
                const records = ref([]);
                const input = ref({ date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' });
                const isEditing = ref(false); const editingId = ref(null); const percentiles = ref({ weight: '', height: '', head: '' });
                const showModal = ref(false); const currentRecord = ref(null);
                const standard = ref('who');
                function changeStandard(s) { standard.value = s; nextTick(() => { calcPercentiles(); renderCharts(); }); }

                // WHO & China Data (ç®€åŒ–ç‰ˆ)
                const growthData = {
                    who: {
                        weight: { male: [3.3, 4.5, 5.6, 6.4, 7.0, 7.5, 7.9, 8.3, 8.6, 8.9, 9.2, 9.4, 9.6], female: [3.2, 4.2, 5.1, 5.8, 6.4, 6.9, 7.3, 7.6, 7.9, 8.2, 8.5, 8.7, 8.9] },
                        height: { male: [49.9, 54.7, 58.4, 61.4, 63.9, 65.9, 67.6, 69.2, 70.6, 72.0, 73.3, 74.5, 75.7], female: [49.1, 53.7, 57.1, 59.8, 62.1, 64.0, 65.7, 67.3, 68.7, 70.1, 71.5, 72.8, 74.0] },
                        head: { male: [34.5, 37.3, 39.1, 40.5, 41.6, 42.6, 43.5, 44.2, 44.8, 45.4, 46.0, 46.5, 47.0], female: [33.9, 36.5, 38.3, 39.5, 40.6, 41.5, 42.2, 42.8, 43.4, 44.0, 44.6, 45.1, 45.6] }
                    },
                    china: {
                        weight: { male: [3.4, 4.8, 6.0, 6.9, 7.6, 8.2, 8.7, 9.1, 9.4, 9.7, 10.0, 10.3, 10.5], female: [3.3, 4.5, 5.5, 6.4, 7.0, 7.6, 8.1, 8.5, 8.8, 9.1, 9.4, 9.7, 9.9] },
                        height: { male: [50.4, 55.8, 59.6, 62.5, 65.1, 67.3, 69.3, 71.0, 72.5, 74.0, 75.3, 76.6, 78.0], female: [49.7, 54.7, 58.4, 61.3, 63.9, 66.1, 68.0, 69.7, 71.2, 72.7, 74.0, 75.3, 76.7] },
                        head: { male: [34.8, 37.8, 39.6, 40.9, 42.0, 43.0, 43.8, 44.5, 45.1, 45.7, 46.2, 46.7, 47.2], female: [34.1, 37.0, 38.8, 40.1, 41.2, 42.1, 42.9, 43.6, 44.2, 44.8, 45.3, 45.8, 46.3] }
                    }
                };

                let charts = {};
                const hasHeadData = computed(() => records.value.some(r => r.head));

                // Auth & Setup
                async function sendMagicCode() { if (!email.value) return alert('Enter email'); loading.value = true; const { error } = await supabase.auth.signInWithOtp({ email: email.value }); loading.value = false; if (error) alert(error.message); else sentCode.value = true; }
                async function verifyOtp() { loading.value = true; const { data, error } = await supabase.auth.verifyOtp({ email: email.value, token: otpToken.value, type: 'email' }); loading.value = false; if (error) alert('Error'); else user.value = data.user; }
                async function signOut() { await supabase.auth.signOut(); user.value = null; babies.value = []; currentBaby.value = null; }
                async function fetchBabies() { const { data } = await supabase.from('babies').select('*').order('created_at', { ascending: false }); babies.value = data || []; }
                async function createBaby() { if(!newBaby.value.name) return; loading.value = true; const { error } = await supabase.from('babies').insert([{ user_id: user.value.id, ...newBaby.value }]); loading.value = false; if(!error) { await fetchBabies(); showAddBabyForm.value = false; } }
                function selectBaby(baby) { currentBaby.value = baby; fetchRecords(baby.id); }

                // æ ¸å¿ƒä¿®å¤: è·å–æ•°æ®åå¼ºåˆ¶é‡ç»˜
                async function fetchRecords(babyId) {
                    const { data } = await supabase.from('records').select('*').eq('baby_id', babyId).order('date', { ascending: false });
                    records.value = data || [];
                    nextTick(() => { calcPercentiles(); renderCharts(); });
                }

                function calcPercentiles() {
                    if (!currentBaby.value) return;
                    const birth = new Date(currentBaby.value.birth_date);
                    const now = new Date(input.value.date);
                    const month = Math.max(0, Math.min(Math.floor((now - birth)/(1000*60*60*24*30)), 12)); 
                    const gender = currentBaby.value.gender;
                    
                    const getPct = (type, val) => {
                        if (!val) return '';
                        const p50 = growthData[standard.value][type][gender][month];
                        const diff = ((val - p50) / p50) * 100;
                        if (Math.abs(diff) < 5) return 'P50 (å®Œç¾)';
                        if (diff > 20) return '>P97 (åé«˜)';
                        if (diff > 10) return 'P85 (è¾ƒé«˜)';
                        if (diff < -20) return '<P3 (åä½)';
                        if (diff < -10) return 'P15 (è¾ƒä½)';
                        return 'æ­£å¸¸';
                    };
                    percentiles.value.weight = getPct('weight', input.value.weight);
                    percentiles.value.height = getPct('height', input.value.height);
                    percentiles.value.head = getPct('head', input.value.head);
                }

                async function submitRecord() {
                    if(!input.value.weight || !input.value.height) return alert('è¯·è¾“å…¥èº«é«˜ä½“é‡');
                    loading.value = true;
                    const days = Math.ceil((new Date(input.value.date) - new Date(currentBaby.value.birth_date)) / 86400000);
                    const payload = { baby_id: currentBaby.value.id, date: input.value.date, days, weight: input.value.weight, height: input.value.height, head: input.value.head || null };

                    try {
                        let aiReport = null;
                        if (!isEditing.value) {
                             const aiRes = await fetch('/api/analyze', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...payload, gender: currentBaby.value.gender, name: currentBaby.value.name, lang: lang.value })
                            });
                            if (aiRes.ok) { const json = await aiRes.json(); aiReport = json.result; }
                        }

                        if (isEditing.value) {
                            // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°åç«‹å³æœ¬åœ°æ›´æ–°æ•°ç»„ + åˆ·æ–°å›¾è¡¨
                            const { error } = await supabase.from('records').update(payload).eq('id', editingId.value);
                            if(error) throw error;
                            
                            // æ‰‹åŠ¨æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œå®ç°"é›¶å»¶è¿Ÿ"
                            const index = records.value.findIndex(r => r.id === editingId.value);
                            if (index !== -1) {
                                records.value[index] = { ...records.value[index], ...payload };
                            }
                        } else {
                            if(aiReport) payload.ai_report = aiReport;
                            const { error } = await supabase.from('records').insert([payload]);
                            if(error) throw error;
                            await fetchRecords(currentBaby.value.id); // æ–°å¢å¿…é¡»é‡æ‹‰
                        }

                        // å¼ºåˆ¶é‡ç»˜
                        nextTick(() => { renderCharts(); calcPercentiles(); });
                        cancelEdit(); 
                    } catch(e) { alert(e.message); } finally { loading.value = false; }
                }

                function editRecord(record) { isEditing.value = true; editingId.value = record.id; input.value = { ...record }; window.scrollTo({ top: 0, behavior: 'smooth' }); calcPercentiles(); }
                function cancelEdit() { isEditing.value = false; editingId.value = null; input.value = { date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' }; percentiles.value = { weight: '', height: '', head: '' }; }
                async function deleteRecord(id) { if(confirm('Del?')) { await supabase.from('records').delete().eq('id', id); fetchRecords(currentBaby.value.id); } }

                async function regenerateReport(record) {
                    loading.value = true;
                    try {
                         const aiRes = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ days: record.days, weight: record.weight, height: record.height, head: record.head, gender: currentBaby.value.gender, name: currentBaby.value.name, lang: lang.value }) });
                        if (aiRes.ok) {
                            const json = await aiRes.json();
                            await supabase.from('records').update({ ai_report: json.result }).eq('id', record.id);
                            record.ai_report = json.result; 
                            currentRecord.value.ai_report = json.result;
                        }
                    } catch(e) { alert('AI Error'); } finally { loading.value = false; }
                }
                function openReport(record) { currentRecord.value = record; showModal.value = true; }
                function calculateAge(d) { return Math.ceil((new Date() - new Date(d))/86400000) + ' ' + t.value.days_old; }
                function renderMarkdown(text) { return marked.parse(text || ''); } // æ¸²æŸ“ Markdown

                // å›¾è¡¨
                function renderCharts() {
                    if(!currentBaby.value) return;
                    const ctxW = document.getElementById('chartWeight'); const ctxH = document.getElementById('chartHeight'); const ctxHead = document.getElementById('chartHead');
                    if(!ctxW || !ctxH) return;
                    const sorted = [...records.value].sort((a,b) => a.days - b.days);
                    const labels = sorted.map(r => `Day ${r.days}`);

                    const draw = (ctx, label, dataVals, color, dataType) => {
                        const chartId = ctx.id;
                        if(charts[chartId]) charts[chartId].destroy(); // é”€æ¯æ—§å›¾è¡¨
                        
                        charts[chartId] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels.length?labels:['Birth'],
                                datasets: [
                                    { label: label, data: dataVals, borderColor: color, backgroundColor: color, tension: 0.3, borderWidth:3, pointRadius:5, pointHoverRadius:7 },
                                    { label: `P50 (${standard.value.toUpperCase()})`, data: sorted.map(r => growthData[standard.value][dataType][currentBaby.value.gender][Math.min(Math.floor(r.days/30),12)]), borderColor: '#cbd5e1', borderDash:[5,5], pointRadius:0 }
                                ]
                            },
                            options: { 
                                responsive: true, maintainAspectRatio: false, 
                                plugins: { 
                                    legend: { display: true, position: 'bottom' },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                if(context.datasetIndex === 1) return context.formattedValue;
                                                const val = context.raw;
                                                const dayIndex = context.dataIndex;
                                                const r = sorted[dayIndex];
                                                const month = Math.min(Math.floor(r.days/30), 12);
                                                const p50 = growthData[standard.value][dataType][currentBaby.value.gender][month];
                                                const diff = ((val - p50) / p50) * 100;
                                                let status = 'æ­£å¸¸';
                                                if(diff > 20) status = 'åé«˜'; else if(diff < -20) status = 'åä½';
                                                return `${val} (${status})`;
                                            }
                                        }
                                    }
                                } 
                            }
                        });
                    };
                    draw(ctxW, 'Weight', sorted.map(r=>r.weight), '#F472B6', 'weight');
                    draw(ctxH, 'Height', sorted.map(r=>r.height), '#2DD4BF', 'height');
                    if(ctxHead && sorted.some(r=>r.head)) draw(ctxHead, 'Head', sorted.map(r=>r.head), '#A78BFA', 'head');
                }

                onMounted(async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    user.value = session?.user || null; globalLoading.value = false;
                    supabase.auth.onAuthStateChange((_, s) => { user.value = s?.user || null; if(user.value) fetchBabies(); });
                    if(user.value) fetchBabies();
                });

                return { user, email, otpToken, sentCode, loading, globalLoading, babies, currentBaby, showAddBabyForm, newBaby, records, input, isEditing, percentiles, submitRecord, editRecord, cancelEdit, deleteRecord, showModal, currentRecord, regenerateReport, openReport, sendMagicCode, verifyOtp, signOut, createBaby, selectBaby, calculateAge, lang, t, toggleLang, hasHeadData, changeStandard, standard, calcPercentiles, renderMarkdown };
            }
        }).mount('#app');
    </script>
</body>
</html>