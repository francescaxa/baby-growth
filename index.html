<!DOCTYPE html>
<html :lang="lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BabyUp ¬∑ Êô∫ËÉΩÊàêÈïøÂä©Êâã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #FFF0F5 0%, #E0F7FA 100%); font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.08); }
        .btn-brand { background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); transition: all 0.2s; }
        .btn-brand:active { transform: scale(0.96); }
        .input-glass { background: rgba(255, 255, 255, 0.8); border: 2px solid #F3F4F6; transition: all 0.3s; }
        .input-glass:focus { background: white; border-color: #FF8E53; box-shadow: 0 0 0 3px rgba(255, 142, 83, 0.1); }
        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 100; background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px; font-weight: 800; color: #FF6B6B; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .lang-switch:hover { transform: scale(1.05); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .report-content h1, .report-content h2, .report-content h3 { color: #EA580C; font-weight: 800; margin-top: 1.5em; margin-bottom: 0.5em; }
        .report-content strong { 
            color: #0f172a; 
            font-weight: 800; 
            background: linear-gradient(120deg, rgba(255, 237, 213, 0.6) 0%, rgba(255, 237, 213, 0.6) 100%); 
            background-repeat: no-repeat; 
            background-size: 100% 40%; 
            background-position: 0 88%; 
        }
        .report-content p { line-height: 1.8; margin-bottom: 1.2em; color: #334155; font-size: 0.95rem; text-align: justify; }
        .report-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        .report-content li { margin-bottom: 0.5em; color: #475569; }

        .chart-tab { @apply px-4 py-2 text-sm font-bold rounded-t-xl border-b-2 border-transparent text-slate-400 transition-all; }
        .chart-tab.active { @apply text-slate-700 bg-slate-50 border-orange-400; }
        
        .reference-section { @apply mt-6 border-t border-slate-100 pt-4; }
        .ref-group { @apply mb-3; }
        .ref-title { @apply text-[11px] font-bold text-slate-700 mb-1 flex items-center gap-1 uppercase tracking-wide; } 
        .ref-content { @apply text-[9px] text-slate-500 leading-relaxed font-sans text-justify tracking-wide; }
        .source-tag { @apply inline-block px-1.5 py-0.5 rounded-[3px] bg-slate-100 text-slate-600 font-bold mr-1.5 text-[8px] tracking-wider; }

        #share-capture-area { position: fixed; top: -9999px; left: -9999px; width: 375px; background: #fff; z-index: -1; }
        .logo-svg text { font-family: 'Nunito', sans-serif; font-weight: 800; }
    </style>
    <script>
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg); 
            return false;
        };
    </script>
</head>
<body class="text-slate-700 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto min-h-screen relative pb-20">
        
        <button @click="toggleLang" class="lang-switch">{{ lang === 'zh' ? 'üá∫üá∏ English' : 'üá®üá≥ ‰∏≠Êñá' }}</button>

        <div v-if="globalLoading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/95 backdrop-blur-md">
            <div class="animate-bounce text-6xl mb-6">üë∂</div>
            <p class="text-slate-500 font-bold tracking-widest text-lg">BabyUp Loading...</p>
        </div>

        <transition name="fade">
            <div v-if="!user" class="p-6 pt-20 flex flex-col items-center justify-center min-h-screen max-w-md mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400">BabyUp</h1>
                    <p class="text-slate-400 mt-2 font-bold tracking-wide text-sm uppercase">{{ t.slogan }}</p>
                </div>

                <div class="glass-card rounded-3xl p-8 w-full shadow-2xl">
                    <div v-if="authMode !== 'verify'" class="flex mb-6 bg-slate-100 p-1 rounded-xl">
                        <button @click="authMode = 'login'" :class="authMode === 'login' ? 'bg-white shadow text-orange-500' : 'text-slate-400'" class="flex-1 py-2 rounded-lg font-bold transition">{{ t.login_tab }}</button>
                        <button @click="authMode = 'register'" :class="authMode === 'register' ? 'bg-white shadow text-orange-500' : 'text-slate-400'" class="flex-1 py-2 rounded-lg font-bold transition">{{ t.register_tab }}</button>
                    </div>

                    <form v-if="authMode === 'login'" @submit.prevent="handleLogin">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">{{ t.email_label }}</label>
                        <input type="email" v-model="email" class="input-glass w-full rounded-xl p-3 mb-4 font-bold" placeholder="name@example.com">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">{{ t.password_label }}</label>
                        <input type="password" v-model="password" class="input-glass w-full rounded-xl p-3 mb-6 font-bold" placeholder="********">
                        <button type="submit" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-lg mb-4">{{ loading ? t.logging_in : t.login_btn }}</button>
                        <button type="button" @click="authMode = 'forgot'" class="w-full text-xs text-slate-400 hover:text-orange-500 font-bold">{{ t.forgot_password }}</button>
                    </form>

                    <form v-if="authMode === 'register'" @submit.prevent="handleRegister">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">{{ t.email_label }}</label>
                        <input type="email" v-model="email" class="input-glass w-full rounded-xl p-3 mb-4 font-bold" placeholder="name@example.com">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">{{ t.set_password }}</label>
                        <input type="password" v-model="password" class="input-glass w-full rounded-xl p-3 mb-6 font-bold" placeholder="Min 6 chars">
                        <button type="submit" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-lg">{{ loading ? t.sending : t.register_btn }}</button>
                    </form>

                    <div v-if="authMode === 'verify'">
                        <h3 class="text-center font-bold text-slate-800 text-lg mb-2">{{ t.verify_title }}</h3>
                        <p class="text-xs text-center text-slate-400 mb-6">{{ t.code_sent_to }} {{ email }}</p>
                        <input type="text" v-model="otpToken" maxlength="6" class="input-glass w-full rounded-xl p-4 outline-none mb-6 text-center text-3xl tracking-[0.5em] font-mono font-bold text-slate-700">
                        <button @click="handleVerifyOtp" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-lg mb-4">{{ loading ? t.verifying : t.confirm_btn }}</button>
                        <button @click="authMode = 'login'" class="w-full text-sm text-slate-400">{{ t.back_login }}</button>
                    </div>
                    
                     <div v-if="authMode === 'forgot'">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">{{ t.reset_title }}</h3>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">{{ t.email_label }}</label>
                        <input type="email" v-model="email" class="input-glass w-full rounded-xl p-3 mb-6 font-bold">
                        <button @click="sendResetCode" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-lg mb-4">{{ loading ? t.sending : t.send_reset_code }}</button>
                        <button @click="authMode = 'login'" class="w-full text-sm text-slate-400 font-bold">{{ t.back_login }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="user" class="p-4 pt-4">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-2">
                         <span class="text-2xl font-extrabold text-orange-500 tracking-tight">BabyUp</span>
                         <span v-if="currentBaby" class="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold border border-orange-200">{{ currentBaby.name }}</span>
                    </div>
                    <div class="flex gap-4 text-sm font-bold text-slate-400">
                        <button v-if="currentBaby" @click="currentBaby = null" class="hover:text-slate-600 transition">{{ t.switch_baby }}</button>
                        <button @click="signOut" class="hover:text-red-500 transition">{{ t.logout }}</button>
                    </div>
                </div>

                <div v-if="!currentBaby && !showAddBabyForm" class="max-w-md mx-auto">
                    <div v-if="babies.length === 0" class="text-center py-20">
                        <div class="text-6xl mb-4">üê£</div>
                        <p class="text-slate-500 mb-6 font-bold">{{ t.no_baby }}</p>
                        <button @click="showAddBabyForm = true" class="btn-brand text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition">+ {{ t.add_baby }}</button>
                    </div>
                    <div v-else class="grid gap-4">
                        <div v-for="baby in babies" :key="baby.id" @click="selectBaby(baby)" class="glass-card p-5 rounded-2xl flex items-center justify-between cursor-pointer hover:scale-[1.02] transition transform duration-200 hover:shadow-md relative group">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-inner" :class="baby.gender === 'male' ? 'bg-blue-100' : 'bg-pink-100'">{{ baby.gender === 'male' ? 'üë¶' : 'üëß' }}</div>
                                <div><h3 class="font-bold text-lg text-slate-800">{{ baby.name }}</h3><p class="text-xs text-slate-500 font-bold">{{ calculateAge(baby.birth_date) }}</p></div>
                            </div>
                            <button @click.stop="openEditBabyModal(baby)" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition shadow-sm z-10">
                                ‚öôÔ∏è
                            </button>
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400" v-if="false">‚ûú</div>
                        </div>
                        <button @click="showAddBabyForm = true" class="mt-4 w-full py-4 border-2 border-dashed border-slate-300 text-slate-400 rounded-2xl font-bold hover:border-orange-300 hover:text-orange-500 transition hover:bg-orange-50">+ {{ t.add_another }}</button>
                    </div>
                </div>

                <div v-if="showEditBabyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                    <div class="glass-card w-full max-w-md p-6 rounded-3xl shadow-2xl relative">
                        <button @click="showEditBabyModal = false" class="absolute top-4 right-4 text-slate-400 font-bold hover:text-slate-600">&times;</button>
                        <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">‚öôÔ∏è {{ t.edit_profile }}</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">{{ t.nickname }}</label>
                                <input type="text" v-model="editingBaby.name" class="input-glass w-full rounded-xl p-3 mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">{{ t.gender }}</label>
                                <div class="flex gap-4 mt-1">
                                    <button @click="editingBaby.gender = 'male'" :class="editingBaby.gender === 'male' ? 'bg-blue-500 text-white ring-2 ring-blue-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.boy }}</button>
                                    <button @click="editingBaby.gender = 'female'" :class="editingBaby.gender === 'female' ? 'bg-pink-500 text-white ring-2 ring-pink-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.girl }}</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">{{ t.birth_date }}</label>
                                <input type="date" :max="todayDate" :lang="lang === 'en' ? 'en-US' : 'zh-CN'" :key="lang" v-model="editingBaby.birth_date" class="input-glass w-full rounded-xl p-3 mt-1">
                                <p class="text-[10px] text-orange-400 mt-1">* {{ t.date_warn }}</p>
                            </div>
                        </div>

                        <div class="mt-8 space-y-3">
                            <button @click="handleUpdateBaby" :disabled="loading" class="btn-brand w-full text-white font-bold py-3 rounded-xl shadow-lg">{{ loading ? t.saving : t.save_changes }}</button>
                            <button @click="handleDeleteBaby" :disabled="loading" class="w-full text-red-400 font-bold py-3 rounded-xl border border-red-100 hover:bg-red-50 transition">{{ t.delete_profile }}</button>
                        </div>
                    </div>
                </div>

                <div v-if="showAddBabyForm" class="max-w-md mx-auto pt-10">
                    <button @click="showAddBabyForm = false" class="text-slate-400 mb-6 font-bold flex items-center gap-1 hover:text-slate-600 transition">‚Üê {{ t.back }}</button>
                    <div class="glass-card rounded-3xl p-6 space-y-4">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">{{ t.new_profile }}</h2>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">{{ t.nickname }}</label><input type="text" v-model="newBaby.name" class="input-glass w-full rounded-xl p-3 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">{{ t.gender }}</label>
                            <div class="flex gap-4 mt-1">
                                <button @click="newBaby.gender = 'male'" :class="newBaby.gender === 'male' ? 'bg-blue-500 text-white ring-2 ring-blue-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.boy }}</button>
                                <button @click="newBaby.gender = 'female'" :class="newBaby.gender === 'female' ? 'bg-pink-500 text-white ring-2 ring-pink-200 shadow-lg' : 'bg-white text-slate-400'" class="flex-1 py-3 rounded-xl font-bold border transition transform active:scale-95">{{ t.girl }}</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">{{ t.birth_date }}</label>
                            <input type="date" :max="todayDate" :lang="lang === 'en' ? 'en-US' : 'zh-CN'" :key="lang" v-model="newBaby.birth_date" class="input-glass w-full rounded-xl p-3 mt-1">
                        </div>
                        <button @click="createBaby" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl mt-4 shadow-xl">{{ loading ? t.saving : t.create_btn }}</button>
                    </div>
                </div>

                <div v-if="currentBaby" class="pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        
                        <div class="md:col-span-4 space-y-6">
                            <div class="glass-card rounded-3xl p-5 border-l-4 border-orange-400 relative transition-all duration-300" :class="isEditing ? 'ring-2 ring-orange-200 shadow-xl' : ''">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                    <span>{{ isEditing ? t.edit_mode : t.record_entry }}</span>
                                    <button v-if="isEditing" @click="cancelEdit" class="text-xs text-red-500 bg-red-100 px-3 py-1 rounded-full font-bold hover:bg-red-200 transition">Cancel</button>
                                </h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <input type="date" :min="currentBaby.birth_date" :max="todayDate" :lang="lang === 'en' ? 'en-US' : 'zh-CN'" :key="lang" v-model="input.date" class="input-glass rounded-xl p-3 text-sm font-bold text-slate-600">
                                    
                                    <div class="relative"><input type="text" inputmode="decimal" v-model="input.weight" :placeholder="t.weight_ph" @input="handleInput('weight')" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-orange-400 bg-orange-50 px-2 py-1 rounded">{{ percentiles.weight }}</span></div>
                                    <div class="relative"><input type="text" inputmode="decimal" v-model="input.height" :placeholder="t.height_ph" @input="handleInput('height')" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-teal-500 bg-teal-50 px-2 py-1 rounded">{{ percentiles.height }}</span></div>
                                    <div class="relative"><input type="text" inputmode="decimal" v-model="input.head" :placeholder="t.head_ph" @input="handleInput('head')" class="input-glass w-full rounded-xl p-3 text-sm pr-16 font-bold"><span class="absolute right-3 top-3 text-xs font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded">{{ percentiles.head }}</span></div>
                                </div>
                                <button @click="submitRecord" :disabled="loading" class="btn-brand w-full text-white font-bold py-3 rounded-xl mt-4 shadow-lg flex justify-center items-center gap-2 transform active:scale-95 transition">
                                    <span v-if="loading" class="animate-spin">‚è≥</span><span>{{ t.gen_report }}</span>
                                </button>
                            </div>
                            <div class="bg-white/60 rounded-3xl p-5 max-h-[500px] overflow-y-auto border border-white shadow-sm">
                                <h3 class="font-bold text-slate-700 mb-3 ml-1">{{ t.history_title }}</h3>
                                <div class="space-y-3 pr-1">
                                    <div v-for="record in records" :key="record.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group relative overflow-hidden">
                                        <div v-if="isEditing && editingId === record.id" class="absolute left-0 top-0 bottom-0 w-1 bg-orange-400"></div>
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-bold text-slate-800 text-sm">{{ record.date }}</span>
                                                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">Day {{ record.days }}</span>
                                                </div>
                                                <div class="text-xs text-slate-500 space-x-2">
                                                    <span class="font-bold text-pink-500">{{ record.weight }}kg</span><span class="font-bold text-teal-500">{{ record.height }}cm</span><span v-if="record.head" class="text-purple-400">{{ record.head }}cm</span>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2 text-right">
                                                <button @click="openReport(record)" class="text-[10px] bg-orange-50 text-orange-500 px-3 py-1.5 rounded-lg font-bold hover:bg-orange-100 transition">{{ record.ai_report ? t.view_report_btn : t.gen_report_btn }}</button>
                                                <div class="flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button @click="editRecord(record)" class="text-[10px] text-blue-400 font-bold hover:underline">{{ t.edit }}</button>
                                                    <button @click="deleteRecord(record.id)" class="text-[10px] text-red-400 font-bold hover:underline">{{ t.del }}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-8">
                            <div class="bg-white rounded-3xl p-6 shadow-sm sticky top-4 min-h-[600px] flex flex-col border border-slate-100">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span>üìä {{ t.chart_title }}</span></div>
                                    <div class="flex bg-slate-100 p-1 rounded-lg">
                                        <button @click="changeStandard('who')" :class="standard === 'who' ? 'bg-white shadow text-orange-500' : 'text-slate-400'" class="text-xs font-bold px-3 py-1.5 rounded-md transition-all">WHO</button>
                                        <button @click="changeStandard('china')" :class="standard === 'china' ? 'bg-white shadow text-red-500' : 'text-slate-400'" class="text-xs font-bold px-3 py-1.5 rounded-md transition-all">China (2022)</button>
                                    </div>
                                </h3>
                                
                                <div class="flex space-x-2 border-b border-slate-100 mb-4">
                                    <button @click="activeChart = 'weight'; nextTick(renderCharts)" :class="activeChart === 'weight' ? 'active text-pink-500 border-pink-400' : ''" class="chart-tab">{{ t.weight_tab }}</button>
                                    <button @click="activeChart = 'height'; nextTick(renderCharts)" :class="activeChart === 'height' ? 'active text-teal-500 border-teal-400' : ''" class="chart-tab">{{ t.height_tab }}</button>
                                    <button @click="activeChart = 'head'; nextTick(renderCharts)" :class="activeChart === 'head' ? 'active text-purple-500 border-purple-400' : ''" class="chart-tab">{{ t.head_tab }}</button>
                                </div>

                                <div class="flex-1 min-h-[400px] relative bg-slate-50 rounded-2xl p-2">
                                    <canvas id="mainChart"></canvas>
                                </div>

                                <div class="reference-section">
                                    <div class="ref-group">
                                        <h4 class="ref-title">
                                            <span class="text-xs">üìù</span> {{ t.notes_title }}
                                        </h4>
                                        <p class="ref-content">
                                            <span class="font-bold text-slate-700">{{ standard === 'who' ? 'WHO (2006)' : 'China (2022)' }}: </span>
                                            {{ standard === 'who' ? t.notes_who : t.notes_china }}
                                        </p>
                                    </div>
                                    <div class="ref-group">
                                        <h4 class="ref-title">
                                            <span class="text-xs">üìö</span> {{ t.refs_title }}
                                        </h4>
                                        <p class="ref-content font-mono bg-slate-50 p-2 rounded border border-slate-100">
                                            {{ standard === 'who' ? t.refs_who : t.refs_china }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </transition>
        
        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showModal = false"></div>
                <div class="bg-white w-full max-w-2xl h-[90vh] sm:h-auto sm:max-h-[90vh] overflow-hidden rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col transform transition-all scale-100">
                    <div class="bg-gradient-to-r from-orange-400 to-pink-500 p-4 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-lg text-white flex items-center gap-2"><span class="text-2xl">ü©∫</span> {{ t.report_title }}</h3>
                        <button @click="showModal = false" class="text-white/80 text-2xl hover:text-white transition">&times;</button>
                    </div>
                    <div class="p-8 overflow-y-auto flex-1 bg-slate-50 report-content">
                        <div v-if="currentRecord && currentRecord.ai_report" v-html="renderMarkdown(currentRecord.ai_report)" class="text-slate-700 max-w-none leading-relaxed"></div>
                        <div v-else class="text-center py-20">
                            <div class="text-6xl mb-4 text-slate-200">üìÑ</div>
                            <p class="text-slate-400 font-bold">{{ t.no_report_yet }}</p>
                        </div>
                        
                        <div v-if="currentRecord" class="mt-8 pt-6 border-t border-slate-200 flex flex-col items-center gap-3">
                            <button @click="generateShareImage" :disabled="loading" class="bg-gradient-to-r from-yellow-300 to-orange-400 text-white font-black py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition flex items-center gap-2 text-sm uppercase tracking-wider">
                                <span>üéÅ</span> {{ t.share_btn }}
                            </button>
                            <p class="text-xs text-slate-400 mb-2">{{ t.outdated_hint }}</p>
                            <button @click="regenerateReport(currentRecord)" :disabled="loading" class="text-xs text-orange-400 font-bold underline hover:text-orange-500 transition">{{ t.regenerate }}</button>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t border-slate-100 shrink-0"><button @click="showModal = false" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 transition">{{ t.close }}</button></div>
                </div>
            </div>
        </transition>

        <div id="share-capture-area" class="p-8 flex flex-col gap-6">
            <div class="text-center mb-2">
                <svg width="300" height="60" viewBox="0 0 300 60" class="mx-auto block" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="brandGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#F87171;stop-opacity:1" /> <stop offset="100%" style="stop-color:#FB923C;stop-opacity:1" /> </linearGradient>
                    </defs>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="url(#brandGradient)" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 40px; letter-spacing: -1px;">BabyUp</text>
                </svg>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mt-[-10px]">Smart Growth Assistant</p>
            </div>
            
            <div class="bg-orange-50 p-4 rounded-2xl flex items-center gap-4">
                <div class="text-4xl">{{ currentBaby?.gender === 'male' ? 'üë¶' : 'üëß' }}</div>
                <div>
                    <h2 class="text-xl font-black text-slate-800">{{ currentBaby?.name }}</h2>
                    <p class="text-sm text-slate-500 font-bold">{{ currentRecord?.date }} ¬∑ Day {{ currentRecord?.days }}</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="relative h-[200px] w-full bg-white rounded-xl border border-slate-100 p-2">
                    <canvas id="shareChartWeight"></canvas>
                </div>
                <div class="relative h-[200px] w-full bg-white rounded-xl border border-slate-100 p-2">
                    <canvas id="shareChartHeight"></canvas>
                </div>
                <div class="relative h-[200px] w-full bg-white rounded-xl border border-slate-100 p-2" v-if="currentRecord?.head">
                    <canvas id="shareChartHead"></canvas>
                </div>
            </div>

            <div class="report-content text-sm" v-if="currentRecord?.ai_report" v-html="renderMarkdown(currentRecord.ai_report)"></div>

            <div class="text-center pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-300">Copyright ¬© BabyUp</p>
            </div>
        </div>

        <transition name="fade">
            <div v-if="showResetPasswordModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4">
                <div class="glass-card w-full max-w-md p-8 rounded-3xl text-center shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">{{ t.reset_modal_title }}</h3>
                    <p class="text-slate-500 mb-6 text-sm">{{ t.reset_modal_desc }}</p>
                    <input type="password" v-model="newPassword" class="input-glass w-full rounded-xl p-3 mb-6 font-bold" placeholder="New Password">
                    <button @click="updatePassword" :disabled="loading" class="btn-brand w-full text-white font-bold py-4 rounded-xl shadow-lg">{{ loading ? t.saving : t.reset_confirm_btn }}</button>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

        const i18n = {
            zh: { slogan: "ÊÇ®ÁöÑ AI ËÇ≤ÂÑø‰∏ìÂÆ∂", login_tab: "ÁôªÂΩï", register_tab: "Ê≥®ÂÜå", login_btn: "ÂÆâÂÖ®ÁôªÂΩï", register_btn: "Á´ãÂç≥Ê≥®ÂÜå", forgot_password: "ÂøòËÆ∞ÂØÜÁ†Å?", reset_title: "ÈáçÁΩÆÂØÜÁ†Å", verify_title: "È™åËØÅÊÇ®ÁöÑÈÇÆÁÆ±", send_reset_code: "ÂèëÈÄÅÂØÜÁ†ÅÈáçÁΩÆÈìæÊé•", back_login: "ËøîÂõûÁôªÂΩï", confirm_btn: "Á°ÆËÆ§È™åËØÅ", set_password: "ËÆæÁΩÆÂØÜÁ†Å (Ëá≥Â∞ë6‰Ωç)", password_label: "ÂØÜÁ†Å", email_label: "ÈÇÆÁÆ±Âú∞ÂùÄ", sending: "ÂèëÈÄÅ‰∏≠...", send_btn: "Ëé∑ÂèñÈ™åËØÅÁ†Å", code_sent_to: "È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅËá≥", code_label: "6 ‰ΩçÊï∞Â≠óÈ™åËØÅÁ†Å", verifying: "È™åËØÅ‰∏≠...", login_confirm: "ËøõÂÖ• BabyUp", back_email: "‰øÆÊîπÈÇÆÁÆ±", my_babies: "ÂÆùÂÆùÂàóË°®", logout: "ÈÄÄÂá∫", no_baby: "Ê¨¢ËøéÔºÅÂÖàÊ∑ªÂä†‰∏Ä‰∏™ÂÆùÂÆùÊ°£Ê°àÂêß", add_baby: "Ê∑ªÂä†ÂÆùÂÆù", add_another: "Ê∑ªÂä†‰∫åÂÆù/‰∏âÂÆù", back: "ËøîÂõû", new_profile: "Êñ∞ÂÆùÂÆùÊ°£Ê°à", nickname: "ÂÆùÂÆùÂ∞èÂêç", gender: "ÊÄßÂà´", boy: "üë¶ Áî∑ÂÆù", girl: "üëß Â•≥ÂÆù", birth_date: "Âá∫ÁîüÊó•Êúü", saving: "‰øùÂ≠ò‰∏≠...", create_btn: "ÂàõÂª∫Ê°£Ê°à", switch_baby: "ÂàáÊç¢", days_old: "Â§©Â§ß", record_entry: "üìù ‰ªäÊó•ÊàêÈïøËÆ∞ÂΩï", edit_mode: "‚úèÔ∏è ÁºñËæëËÆ∞ÂΩï (‰øÆÊîπÂêéÈáçÊñ∞ÁîüÊàêÊä•Âëä)", update_btn: "‰øùÂ≠òÂπ∂ÁîüÊàêÊä•Âëä", weight_ph: "‰ΩìÈáç (kg)", height_ph: "Ë∫´È´ò (cm)", head_ph: "Â§¥Âõ¥ (cm, ÈÄâÂ°´)", ai_thinking: "AI ‰∏ìÂÆ∂ÊÄùËÄÉ‰∏≠...", gen_report: "ÁîüÊàê AI ÊàêÈïøËß£ËØª ‚ú®", chart_title: "ÁîüÈïøÊõ≤Á∫ø", realtime: "ÂÆûÊó∂", history_title: "üìÖ ÂéÜÂè≤Ê°£Ê°à", view_report_btn: "üìÑ Êü•ÁúãÊä•Âëä", gen_report_btn: "‚ú® ÁîüÊàêÊä•Âëä", report_title: "AI Ê∑±Â∫¶Ëß£ËØª", close: "ÂÖ≥Èó≠", connecting: "Ê≠£Âú®ËøûÊé• BabyUp ‰∫ëÁ´Ø...", edit: "ÁºñËæë", del: "Âà†Èô§", no_report_yet: "ÊöÇÊó† AI Êä•Âëä", outdated_hint: "Êï∞ÊçÆÊõ¥Êñ∞ÂêéÔºåÂèØÈáçÊñ∞Ëß£ËØª", regenerate: "ÈáçÊñ∞ÁîüÊàêÊä•Âëä", logging_in: "ÁôªÂΩï‰∏≠...", weight_tab: "‰ΩìÈáç", height_tab: "Ë∫´È´ò", head_tab: "Â§¥Âõ¥", date_too_early: "Êó•ÊúüÊó†ÊïàÔºö‰∏çËÉΩÊó©‰∫éÂÆùÂÆùÂá∫ÁîüÊó•ÊúüÔºÅ", reset_modal_title: "üîí ËÆæÁΩÆÊñ∞ÂØÜÁ†Å", reset_modal_desc: "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊñ∞ÂØÜÁ†Å‰ª•ÊÅ¢Â§çËÆøÈóÆÊùÉÈôê", reset_confirm_btn: "Êõ¥Êñ∞ÂØÜÁ†Å", notes_title: "Â§áÊ≥®", refs_title: "ÂèÇËÄÉÊñáÁåÆ", notes_who: "Âü∫‰∫éWHOÂ§ö‰∏≠ÂøÉÁîüÈïøÂèÇËÄÉÁ†îÁ©∂(MGRS)„ÄÇÁî®‰∫éËØÑ‰º∞0-60‰∏™ÊúàÂÑøÁ´•ÁöÑÁîüÈïøÂèëËÇ≤Áä∂ÂÜµ„ÄÇ", refs_who: "WHO Multicentre Growth Reference Study Group. WHO Child Growth Standards[S]. Geneva: World Health Organization, 2006.", notes_china: "Ê†πÊçÆÂõΩÂÆ∂Âç´ÁîüÂÅ•Â∫∑ÂßîÂèëÂ∏ÉÁöÑÊúÄÊñ∞Âç´ÁîüË°å‰∏öÊ†áÂáÜ„ÄÇ2023Âπ¥3Êúà1Êó•Ëµ∑ÊñΩË°åÔºåÊõø‰ª£2009Âπ¥ÊóßÁâàÊ†áÂáÜ„ÄÇ", refs_china: "‰∏≠Âçé‰∫∫Ê∞ëÂÖ±ÂíåÂõΩÂõΩÂÆ∂Âç´ÁîüÂÅ•Â∫∑ÂßîÂëò‰ºö. WS/T 423‚Äî2022 7Â≤Å‰ª•‰∏ãÂÑøÁ´•ÁîüÈïøÊ†áÂáÜ[S]. Âåó‰∫¨: ‰∏≠ÂõΩÊ†áÂáÜÂá∫ÁâàÁ§æ, 2022.", share_btn: "ÁîüÊàêÊàêÈïøÊµ∑Êä• (ÈïøÂõæ)", generating: "Ê≠£Âú®ÁªòÂà∂...",
                // üöÄ V11.0: Ê°£Ê°àÁÆ°ÁêÜ
                edit_profile: "ÁºñËæëÂÆùÂÆùÊ°£Ê°à", save_changes: "‰øùÂ≠ò‰øÆÊîπ", delete_profile: "üóëÔ∏è Âà†Èô§Ê≠§Ê°£Ê°à", date_warn: "‚ö†Ô∏è ‰øÆÊîπÁîüÊó•‰ºöËá™Âä®ÈáçÁÆóÊâÄÊúâÂéÜÂè≤Êï∞ÊçÆ"
            },
            en: { slogan: "Your AI Parenting Expert", login_tab: "Login", register_tab: "Register", login_btn: "Secure Login", register_btn: "Sign Up Now", forgot_password: "Forgot Password?", reset_title: "Reset Password", verify_title: "Verify Your Email", send_reset_code: "Send Password Reset Link", back_login: "Back to Login", confirm_btn: "Confirm Verify", set_password: "Set Password (min 6 chars)", password_label: "Password", email_label: "Email Address", sending: "Sending...", send_btn: "Get Code", code_sent_to: "Code sent to", code_label: "6-Digit Code", verifying: "Verifying...", login_confirm: "Enter BabyUp", back_email: "Change Email", my_babies: "My Babies", logout: "Logout", no_baby: "Welcome! Add a baby profile first", add_baby: "Add Baby", add_another: "Add Another Baby", back: "Back", new_profile: "New Profile", nickname: "Nickname", gender: "Gender", boy: "üë¶ Boy", girl: "üëß Girl", birth_date: "Birth Date", saving: "Saving...", create_btn: "Create Profile", switch_baby: "Switch", days_old: "days old", record_entry: "üìù Data Entry", edit_mode: "‚úèÔ∏è Edit Record", update_btn: "Save & Generate Report", weight_ph: "Weight (kg)", height_ph: "Height (cm)", head_ph: "Head Circ. (cm, optional)", ai_thinking: "AI Thinking...", gen_report: "Generate AI Report ‚ú®", chart_title: "Growth Charts", realtime: "Live", history_title: "üìÖ History", view_report_btn: "üìÑ View Report", gen_report_btn: "‚ú® AI Report", report_title: "AI Insight", close: "Close", connecting: "Connecting to BabyUp...", edit: "Edit", del: "Del", no_report_yet: "No Report", outdated_hint: "Data changed? Regenerate report.", regenerate: "Regenerate Report", logging_in: "Logging in...", weight_tab: "Weight", height_tab: "Height", head_tab: "Head", date_too_early: "Invalid Date: Cannot be earlier than birth date!", reset_modal_title: "üîí Set New Password", reset_modal_desc: "Please enter your new password to regain access", reset_confirm_btn: "Update Password", notes_title: "Notes", refs_title: "References", notes_who: "Based on the WHO Multicentre Growth Reference Study (MGRS). Generates z-scores and percentiles for children 0-5 years.", refs_who: "WHO Multicentre Growth Reference Study Group. WHO Child Growth Standards[S]. Geneva: World Health Organization, 2006.", notes_china: "Based on the latest industry standard issued by the NHC. Implemented on March 1, 2023.", refs_china: "National Health Commission of the PRC. WS/T 423‚Äî2022 Growth Standard for Children under 7 Years of Age[S]. Beijing: Standards Press of China, 2022.", share_btn: "Share Growth Poster", generating: "Drawing...",
                // üöÄ V11.0
                edit_profile: "Edit Profile", save_changes: "Save Changes", delete_profile: "üóëÔ∏è Delete Profile", date_warn: "‚ö†Ô∏è Changing DOB will recalculate all data"
            }
        };

        createApp({
            setup() {
                // üëá ÊõøÊç¢ÊÇ®ÁöÑ Key
                const SUPABASE_URL = 'https://lihtuqbwilqlmxhacgeu.supabase.co'; 
                const SUPABASE_KEY = 'sb_publishable_hatyIe4q8Fr71ksOngaoig_troXToGR';
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const lang = ref('zh'); const t = computed(() => i18n[lang.value]);
                function toggleLang() { lang.value = lang.value === 'zh' ? 'en' : 'zh'; nextTick(() => { calcPercentiles(); renderCharts(); }); }

                const user = ref(null); const authMode = ref('login'); const email = ref(''); const password = ref(''); const otpToken = ref(''); 
                const loading = ref(false); const globalLoading = ref(true); const sentCode = ref(false);
                const babies = ref([]); const currentBaby = ref(null); const showAddBabyForm = ref(false); const newBaby = ref({ name: '', gender: 'male', birth_date: '' });
                const records = ref([]); const input = ref({ date: new Date().toISOString().split('T')[0], weight: '', height: '', head: '' });
                const isEditing = ref(false); const editingId = ref(null); const percentiles = ref({ weight: '', height: '', head: '' });
                const showModal = ref(false); const currentRecord = ref(null); 
                const standard = ref('who');
                const activeChart = ref('weight');
                const todayDate = new Date().toISOString().split('T')[0];
                const showResetPasswordModal = ref(false);
                const newPassword = ref('');
                
                // üöÄ V11.0: Ê°£Ê°àÁºñËæëÁä∂ÊÄÅ
                const showEditBabyModal = ref(false);
                const editingBaby = ref({ id: null, name: '', gender: '', birth_date: '' });

                function changeStandard(s) { standard.value = s; nextTick(() => { calcPercentiles(); renderCharts(); }); }

                // V9.0: ÂåªÁñóÊï∞ÊçÆÂºïÊìé
                const growthData = {
                    who: {
                        weight: { 
                            male: { p3: [2.5,3.4,4.3,5.0,5.6,6.0,6.4,6.7,6.9,7.1,7.4,7.6,7.7], p50: [3.3,4.5,5.6,6.4,7.0,7.5,7.9,8.3,8.6,8.9,9.2,9.4,9.6], p97: [4.2,5.8,7.1,8.0,8.7,9.3,9.8,10.3,10.7,11.0,11.4,11.7,12.0] }, 
                            female: { p3: [2.4,3.2,3.9,4.5,5.0,5.4,5.7,6.0,6.3,6.5,6.7,6.9,7.0], p50: [3.2,4.2,5.1,5.8,6.4,6.9,7.3,7.6,7.9,8.2,8.5,8.7,8.9], p97: [4.2,5.5,6.6,7.5,8.2,8.8,9.3,9.8,10.2,10.5,10.9,11.2,11.5] } 
                        },
                        height: {
                            male: { p3: [46.1,50.8,54.4,57.3,59.7,61.7,63.3,64.8,66.2,67.5,68.7,69.9,71.0], p50: [49.9,54.7,58.4,61.4,63.9,65.9,67.6,69.2,70.6,72.0,73.3,74.5,75.7], p97: [53.7,58.6,62.4,65.5,68.0,70.1,71.9,73.5,75.0,76.5,77.9,79.2,80.5] },
                            female: { p3: [45.4,49.8,53.0,55.6,57.8,59.6,61.2,62.7,64.0,65.3,66.5,67.7,68.9], p50: [49.1,53.7,57.1,59.8,62.1,64.0,65.7,67.3,68.7,70.1,71.5,72.8,74.0], p97: [52.9,57.6,61.1,64.0,66.4,68.5,70.3,71.9,73.5,75.0,76.4,77.8,79.2] }
                        },
                        head: {
                            male: { p3: [31.9,34.8,36.7,38.1,39.3,40.3,41.2,42.0,42.7,43.3,43.9,44.5,45.0], p50: [34.5,37.3,39.1,40.5,41.6,42.6,43.5,44.2,44.8,45.4,46.0,46.5,47.0], p97: [37.2,39.8,41.5,42.9,44.0,45.0,45.8,46.5,47.1,47.6,48.2,48.7,49.2] },
                            female: { p3: [31.5,34.2,36.0,37.3,38.4,39.4,40.3,41.0,41.7,42.3,42.9,43.4,43.9], p50: [33.9,36.5,38.3,39.5,40.6,41.5,42.2,42.8,43.4,44.0,44.6,45.1,45.6], p97: [36.2,39.0,40.6,41.9,43.0,43.9,44.6,45.3,45.9,46.4,46.9,47.4,47.9] }
                        }
                    },
                    china: {
                        weight: {
                            male: { p3: [2.6,3.6,4.6,5.4,6.0,6.5,7.0,7.3,7.6,7.9,8.2,8.4,8.6], p50: [3.5,4.9,6.0,6.9,7.6,8.2,8.7,9.1,9.4,9.7,10.0,10.3,10.5], p97: [4.4,6.2,7.5,8.5,9.3,10.0,10.6,11.1,11.5,11.9,12.3,12.6,12.9] },
                            female: { p3: [2.6,3.4,4.2,4.9,5.5,6.0,6.4,6.7,7.0,7.3,7.5,7.7,7.9], p50: [3.4,4.5,5.5,6.4,7.0,7.6,8.1,8.5,8.8,9.1,9.4,9.7,9.9], p97: [4.3,5.7,7.0,8.0,8.8,9.5,10.0,10.5,10.9,11.3,11.7,12.0,12.3] }
                        },
                        height: {
                            male: { p3: [47.1,51.8,55.5,58.5,61.0,63.1,65.0,66.6,68.0,69.5,70.8,72.0,73.3], p50: [50.8,55.8,59.6,62.5,65.1,67.3,69.3,71.0,72.5,74.0,75.3,76.6,78.0], p97: [54.5,59.8,63.7,66.6,69.1,71.3,73.3,75.1,76.8,78.4,79.9,81.3,82.7] },
                            female: { p3: [46.5,50.8,54.4,57.3,59.7,61.9,63.8,65.4,66.8,68.2,69.6,70.8,72.0], p50: [50.1,54.7,58.4,61.3,63.9,66.1,68.0,69.7,71.2,72.7,74.0,75.3,76.7], p97: [53.7,58.6,62.4,65.4,68.0,70.3,72.2,73.9,75.6,77.1,78.6,80.0,81.4] }
                        },
                        head: {
                            male: { p3: [32.5,35.0,36.8,38.1,39.1,40.1,40.9,41.6,42.2,42.8,43.3,43.8,44.3], p50: [35.2,37.8,39.6,40.9,42.0,43.0,43.8,44.5,45.1,45.7,46.2,46.7,47.2], p97: [37.7,40.5,42.3,43.7,44.8,45.8,46.7,47.4,48.0,48.6,49.1,49.6,50.1] },
                            female: { p3: [31.9,34.3,36.0,37.3,38.4,39.3,40.1,40.8,41.4,41.9,42.4,42.9,43.4], p50: [34.5,37.0,38.8,40.1,41.2,42.1,42.9,43.6,44.2,44.8,45.3,45.8,46.3], p97: [37.0,39.7,41.5,42.8,44.0,45.0,45.8,46.5,47.1,47.7,48.2,48.7,49.2] }
                        }
                    }
                };

                let mainChart = null;

                async function handleLogin() { if(!email.value||!password.value) return; loading.value=true; const {data,error}=await supabase.auth.signInWithPassword({email:email.value,password:password.value}); loading.value=false; if(error)alert(error.message);else user.value=data.user; }
                async function handleRegister() { if(!email.value||!password.value) return; if(password.value.length<6)return alert('Min 6'); loading.value=true; const {data,error}=await supabase.auth.signUp({email:email.value,password:password.value}); loading.value=false; if(error)alert(error.message);else {authMode.value='verify';sentCode.value=true;} }
                async function handleVerifyOtp() { if(!otpToken.value) return; loading.value=true; const {data,error}=await supabase.auth.verifyOtp({email:email.value,token:otpToken.value,type:'signup'}); loading.value=false; if(error)alert(error.message);else {user.value=data.user;authMode.value='login';} }
                async function sendResetCode() { if(!email.value) return; loading.value=true; const {error}=await supabase.auth.resetPasswordForEmail(email.value, { redirectTo: window.location.href }); loading.value=false; if(error)alert(error.message);else alert(t.value.sending); }
                async function signOut() { await supabase.auth.signOut(); user.value=null; babies.value=[]; currentBaby.value=null; authMode.value='login'; }
                
                async function updatePassword() { if(newPassword.value.length<6) return alert('Min 6 chars'); loading.value=true; const {error} = await supabase.auth.updateUser({password: newPassword.value}); loading.value=false; if(error) alert(error.message); else { alert('Success!'); showResetPasswordModal.value=false; newPassword.value=''; } }

                async function fetchBabies() { const {data}=await supabase.from('babies').select('*').order('created_at',{ascending:false}); babies.value=data||[]; }
                async function createBaby() { if(!newBaby.value.name||!newBaby.value.birth_date)return; if(new Date(newBaby.value.birth_date)>new Date())return alert('No future date'); loading.value=true; const {error}=await supabase.from('babies').insert([{user_id:user.value.id,...newBaby.value}]); loading.value=false; if(!error){await fetchBabies();showAddBabyForm.value=false;} }
                function selectBaby(baby) { currentBaby.value=baby; fetchRecords(baby.id); }
                
                // üöÄ V11.0: Âä®ÊÄÅËÆ°ÁÆóÂ§©Êï∞ (Ê†∏ÂøÉ‰øÆÂ§ç)
                async function fetchRecords(babyId) { 
                    const {data} = await supabase.from('records').select('*').eq('baby_id',babyId).order('date',{ascending:false});
                    const birth = new Date(currentBaby.value.birth_date);
                    // Êó†ËÆ∫Êï∞ÊçÆÂ∫ìÂ≠ò‰∫Ü‰ªÄ‰πàÔºåËøôÈáåÈÉΩÂº∫Âà∂Ê†πÊçÆ‚ÄúÂΩìÂâçÁîüÊó•‚ÄùÈáçÊñ∞ËÆ°ÁÆóÂ§©Êï∞
                    records.value = (data||[]).map(r => {
                        const recordDate = new Date(r.date);
                        const dynamicDays = Math.ceil((recordDate - birth)/86400000);
                        return { ...r, days: dynamicDays };
                    });
                    nextTick(()=>{calcPercentiles(); renderCharts();}); 
                }

                function handleInput(field) { calcPercentiles(); }

                // üöÄ V11.0: Ê°£Ê°àÁÆ°ÁêÜÈÄªËæë
                function openEditBabyModal(baby) {
                    editingBaby.value = { ...baby }; // Clone data
                    showEditBabyModal.value = true;
                }

                async function handleUpdateBaby() {
                    if(!editingBaby.value.name || !editingBaby.value.birth_date) return alert('Missing info');
                    loading.value = true;
                    const { error } = await supabase.from('babies').update({
                        name: editingBaby.value.name,
                        gender: editingBaby.value.gender,
                        birth_date: editingBaby.value.birth_date
                    }).eq('id', editingBaby.value.id);
                    
                    loading.value = false;
                    if(error) return alert(error.message);
                    
                    showEditBabyModal.value = false;
                    await fetchBabies(); // Refresh list
                    
                    // Â¶ÇÊûúÊ≠£Âú®Êü•ÁúãËøô‰∏™ÂÆùÂÆùÔºåÁ´ãÂç≥Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
                    if (currentBaby.value && currentBaby.value.id === editingBaby.value.id) {
                        currentBaby.value = editingBaby.value;
                        await fetchRecords(currentBaby.value.id); // Re-fetch & Re-calc
                    }
                }

                async function handleDeleteBaby() {
                    if(!confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂÆùÂÆùÊ°£Ê°àÂêóÔºü\nÊâÄÊúâÁîüÈïøËÆ∞ÂΩïÈÉΩÂ∞ÜÊ∞∏‰πÖ‰∏¢Â§±ÔºÅ')) return;
                    loading.value = true;
                    // ÂÖàÂà†ËÆ∞ÂΩïÔºåÂÜçÂà†ÂÆùÂÆù (Safe Delete)
                    await supabase.from('records').delete().eq('baby_id', editingBaby.value.id);
                    const { error } = await supabase.from('babies').delete().eq('id', editingBaby.value.id);
                    
                    loading.value = false;
                    if(error) return alert(error.message);
                    
                    showEditBabyModal.value = false;
                    if (currentBaby.value && currentBaby.value.id === editingBaby.value.id) {
                        currentBaby.value = null; // Clear view
                    }
                    await fetchBabies();
                }

                function calcPercentiles() {
                    if (!currentBaby.value) return;
                    const birth = new Date(currentBaby.value.birth_date);
                    const now = new Date(input.value.date);
                    const month = Math.max(0, Math.min(Math.floor((now - birth)/(1000*60*60*24*30)), 12)); 
                    const gender = currentBaby.value.gender;
                    const getPct = (type, val) => {
                        const numVal = parseFloat(val);
                        if (!numVal) return '';
                        const p50 = growthData[standard.value][type][gender].p50[month];
                        const diff = ((numVal - p50) / p50) * 100;
                        if (Math.abs(diff) < 5) return 'P50'; if (diff > 20) return '>P97'; if (diff > 10) return 'P85'; if (diff < -20) return '<P3'; if (diff < -10) return 'P15'; return 'Normal';
                    };
                    percentiles.value.weight = getPct('weight', input.value.weight);
                    percentiles.value.height = getPct('height', input.value.height);
                    percentiles.value.head = getPct('head', input.value.head);
                }

                async function submitRecord() {
                    const w=parseFloat(input.value.weight); const h=parseFloat(input.value.height);
                    if(!w||!h) return alert('Input required');
                    if(w<1||w>50) return alert('Invalid weight'); if(h<20||h>150) return alert('Invalid height');
                    
                    const recordDate = new Date(input.value.date);
                    const birthDate = new Date(currentBaby.value.birth_date);
                    
                    if(recordDate < birthDate) return alert(t.value.date_too_early);
                    if(recordDate > new Date()) return alert('No future date');
                    
                    loading.value=true;
                    const days=Math.ceil((recordDate - birthDate)/86400000);
                    const headVal = input.value.head ? parseFloat(input.value.head) : null;
                    const payload={baby_id:currentBaby.value.id,date:input.value.date,days,weight:w,height:h,head:headVal};

                    try {
                        let aiReport = null;
                        const aiRes = await fetch('/api/analyze', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...payload, gender: currentBaby.value.gender, name: currentBaby.value.name, lang: lang.value })
                        });

                        if (aiRes.ok) { 
                            const json = await aiRes.json(); 
                            aiReport = json.result; 
                        } else {
                            throw new Error("AI Generation Failed");
                        }

                        if(aiReport) payload.ai_report = aiReport;

                        if (isEditing.value) {
                            const {error} = await supabase.from('records').update(payload).eq('id', editingId.value);
                            if(error) throw error;
                        } else {
                            const {error} = await supabase.from('records').insert([payload]);
                            if(error) throw error;
                        }
                        
                        currentRecord.value = { ...payload, ai_report: aiReport };
                        showModal.value = true;

                        await fetchRecords(currentBaby.value.id);
                        nextTick(() => { renderCharts(); calcPercentiles(); });
                        cancelEdit(); 

                    } catch(e) { 
                        alert('Error: ' + e.message); 
                    } finally { 
                        loading.value = false; 
                    }
                }

                async function regenerateReport(record) { 
                    loading.value=true; 
                    try { 
                        const aiRes=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({days:record.days,weight:record.weight,height:record.height,head:record.head,gender:currentBaby.value.gender,name:currentBaby.value.name,lang:lang.value})}); 
                        if(aiRes.ok){ 
                            const json=await aiRes.json(); 
                            await supabase.from('records').update({ai_report:json.result}).eq('id',record.id); 
                            record.ai_report=json.result; 
                            currentRecord.value.ai_report=json.result; 
                            showModal.value = true; 
                        } else {
                            throw new Error('AI Service Error'); 
                        }
                    } catch(e){ 
                        alert('Error generating report: ' + e.message); 
                    } finally{ 
                        loading.value=false; 
                    } 
                }

                async function generateShareImage() {
                    loading.value = true;
                    const types = ['weight', 'height'];
                    if (currentRecord.value.head) types.push('head');
                    
                    types.forEach(type => {
                        const canvas = document.getElementById(`shareChart${type.charAt(0).toUpperCase() + type.slice(1)}`);
                        if (canvas) {
                            const existingChart = Chart.getChart(canvas);
                            if(existingChart) existingChart.destroy();

                            const sorted = [...records.value].sort((a,b) => a.days - b.days);
                            const labels = sorted.map(r => `Day ${r.days}`);
                            const gender = currentBaby.value.gender;
                            const stdData = growthData[standard.value][type][gender];
                            const getStdPoints = (arr) => sorted.map(r => arr[Math.min(Math.floor(r.days/30), 12)]);
                            const colors = { weight: '#F472B6', height: '#2DD4BF', head: '#A78BFA' };
                            
                            new Chart(canvas, {
                                type: 'line',
                                data: {
                                    labels: labels.length ? labels : ['Birth'],
                                    datasets: [
                                        { label: `${currentBaby.value.name} (${t.value[type+'_tab']})`, data: sorted.map(r => r[type]), borderColor: colors[type], backgroundColor: colors[type], borderWidth: 3, pointRadius: 4, tension: 0.3 },
                                        { label: 'P50', data: getStdPoints(stdData.p50), borderColor: '#94a3b8', borderWidth: 1, borderDash: [5, 5], pointRadius: 0 }
                                    ]
                                },
                                options: { 
                                    responsive: true, 
                                    maintainAspectRatio: false, 
                                    animation: false,
                                    plugins: { legend: { position: 'top' } } 
                                }
                            });
                        }
                    });

                    await new Promise(r => setTimeout(r, 500));

                    const element = document.getElementById('share-capture-area');
                    try {
                        const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                        const link = document.createElement('a');
                        link.download = `BabyUp_${currentBaby.value.name}_Report.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } catch (e) {
                        alert('Generate failed: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                }

                function editRecord(record) { 
                    isEditing.value=true; 
                    editingId.value=record.id; 
                    input.value={ ...record, weight: String(record.weight), height: String(record.height), head: record.head ? String(record.head) : '' }; 
                    window.scrollTo({top:0,behavior:'smooth'}); 
                    calcPercentiles(); 
                }
                
                function cancelEdit() { isEditing.value=false; editingId.value=null; input.value={date:new Date().toISOString().split('T')[0],weight:'',height:'',head:''}; percentiles.value={weight:'',height:'',head:''}; }
                async function deleteRecord(id) { 
                    if(confirm('Delete record?')) { 
                        const { error } = await supabase.from('records').delete().eq('id',id); 
                        if(error) alert('Delete failed: ' + error.message);
                        else {
                            fetchRecords(currentBaby.value.id); 
                        }
                    } 
                }
                function openReport(record) { currentRecord.value=record; showModal.value=true; }
                function calculateAge(d) { return Math.ceil((new Date()-new Date(d))/86400000)+' '+t.value.days_old; }
                function renderMarkdown(text) { return marked.parse(text||''); }

                function renderCharts() {
                    if(!currentBaby.value) return;
                    const ctx = document.getElementById('mainChart'); if(!ctx) return;
                    if(mainChart) mainChart.destroy();
                    const sorted = [...records.value].sort((a,b) => a.days - b.days);
                    const labels = sorted.map(r => `Day ${r.days}`);
                    const gender = currentBaby.value.gender;
                    const type = activeChart.value;
                    
                    const stdData = growthData[standard.value][type][gender];
                    const getStdPoints = (arr) => sorted.map(r => arr[Math.min(Math.floor(r.days/30), 12)]);
                    const colors = { weight: '#F472B6', height: '#2DD4BF', head: '#A78BFA' };
                    const mainColor = colors[type];
                    
                    mainChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels.length ? labels : ['Birth'],
                            datasets: [
                                { label: `${currentBaby.value.name}`, data: sorted.map(r => r[type]), borderColor: mainColor, backgroundColor: mainColor, borderWidth: 4, pointRadius: 6, pointHoverRadius: 8, tension: 0.3, order: 1 },
                                { label: 'P50 (Standard)', data: getStdPoints(stdData.p50), borderColor: '#94a3b8', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, tension: 0.4, order: 2 },
                                { label: 'P97', data: getStdPoints(stdData.p97), borderColor: '#cbd5e1', borderWidth: 1, pointRadius: 0, tension: 0.4, order: 3 },
                                { label: 'P3', data: getStdPoints(stdData.p3), borderColor: '#cbd5e1', borderWidth: 1, pointRadius: 0, tension: 0.4, fill: '-1', backgroundColor: 'rgba(241, 245, 249, 0.5)', order: 4 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { if(context.datasetIndex > 0) return context.dataset.label + ': ' + context.formattedValue; const val = context.raw; const dayIndex = context.dataIndex; const r = sorted[dayIndex]; const month = Math.min(Math.floor(r.days/30), 12); const p50 = stdData.p50[month]; const diff = ((val - p50) / p50) * 100; let status = 'Ê≠£Â∏∏'; if(diff > 20) status = 'ÂÅèÈ´ò'; else if(diff < -20) status = 'ÂÅè‰Ωé'; return `${currentBaby.value.name}: ${val} (${status})`; } } } }, scales: { y: { beginAtZero: false, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } }
                    });
                }

                onMounted(async () => {
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        user.value = session?.user || null;
                        globalLoading.value = false;

                        supabase.auth.onAuthStateChange((event, session) => { 
                            user.value = session?.user || null; 
                            if(user.value) fetchBabies();
                            if(event === 'PASSWORD_RECOVERY') {
                                showResetPasswordModal.value = true;
                            }
                        });

                        if(user.value) fetchBabies();
                    } catch (e) {
                        console.error('App Init Error:', e.message);
                        globalLoading.value = false;
                    }
                });

                return { user, authMode, email, password, otpToken, sentCode, loading, globalLoading, babies, currentBaby, showAddBabyForm, newBaby, records, input, isEditing, percentiles, submitRecord, editRecord, cancelEdit, deleteRecord, showModal, currentRecord, regenerateReport, openReport, handleLogin, handleRegister, handleVerifyOtp, sendResetCode, signOut, createBaby, selectBaby, calculateAge, lang, t, toggleLang, changeStandard, standard, calcPercentiles, renderMarkdown, todayDate, activeChart, nextTick, renderCharts, showResetPasswordModal, newPassword, updatePassword, handleInput, generateShareImage, showEditBabyModal, editingBaby, openEditBabyModal, handleUpdateBaby, handleDeleteBaby };
            }
        }).mount('#app');
    </script>
</body>
</html>